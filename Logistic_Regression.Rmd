---
title: "Logistic Multinomial Regresion"
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: false
    toc_depth: 1
    #code_folding: hide
---

The following code will show you how I created functions to run my multinomial regressions. This page includes:

1. Create function to run univariate multinomial regressions.
2. Run block 1 of the step wise multivariate multinomial regression.
3. Run block 2 of the step wise multivariate multinomial regression. 
4. Create function for block 3 of step wise multivariate multinomial regression.
5. Obtain R^2 values for each varaible in regressio model, and R^2 change between blocks of the stepwise regression
6. Run function for block 3 of the step wise multivariate multinomial regression.
7. Create table of output from stepwise regression model. 

--- 
```{r setup, include=FALSE}
# Setup
#libraries

if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, dplyr, haven,kableExtra,MASS,nnet,performance,fuzzySim, 
               boot, broom,aod,caret)

  #data stuff
library(tidyverse)
library(dplyr)
  #CSV/CAV files
library(haven)
  #EDA stuff
library(kableExtra)
library(MASS)
library(nnet)
library(performance)
library(fuzzySim) #FDR corrections
library(broom) #for tidy models
  library(aod) # Wald test
library(boot) #bootstrapping
#library(caret) #weight analysis???
options(knitr.table.format = "html") 

## Prepare Data For Analysis 

#### Import & Select data
path <- "/Users/troyh/OneDrive/Documents/R/Data/NHRVS_2019_2020_FINAL_weighted.sav"



  ifelse(Sys.info()[[1]] == "Windows","/Users/troyh/OneDrive/Documents/R/Data/NHRVS_2019_2020_FINAL_weighted.sav",
       ifelse(Sys.info()[[1]] == "Darwin", "~/Desktop/Adams_lab/SPSS_stuff/NHRVS_2019_2020_FINAL_weighted.sav", "¿¿Donde Estoy??"
       ))

### Import dataset 
NHRVS_2019 <- read_sav(path)




### Select and rename Variables
thesis_NHRVS <- dplyr::select(NHRVS_2019,
    #Background Variables __________
      caseid,weight,Age,Male_Gender,White_Race,SomeCollege_or_Higher,
      Married_Partnered,Income_60k_plus,YN_work,
      PCS_FINAL,MCS_FINAL,Weight_kg,BMI,
    #Military variables__________
      Combat_Veteran,Years_in_Military,Branch_5cat,Enlistment_status_3cat,
      MilitaryRank_3cat,
    #Mental Health Variables___________
      TOTAL_TRAUMAS,PM_PCL_31,MDD_POSITIVE_CURRENT,GAD_POSITIVE_CURRENT,SI_CURRENT,
      AUD_CURRENT,DUD_CURRENT,Concussion_PosScreen,tot_MHC,Any_MHC,
    #Physical health Variables_________
      ANY_ADL_DISABILITY,ANY_IADL_DISABILITY,Any_Disability,tot_phc,Any_PHC,Q22A_1,Q22A_2,
      Q22A_3,Q22A_4,Q22A_5,Q22A_6,Q22A_7,Q22A_8,Q22A_9,Q22A_10,Q22A_11,Q22B_1,
      Q22B_2,Q22B_3,Q22B_4,Q22B_5,
    #Exercise variables ___________
      godin_mild_winsor,godin_Mod_winsor,godin_Stren_winsor,HCS,HCS_Cats,
      godin_total_ac,god3cat,god2cat,GODIN_outliers)
    
#Rename variabes
thesis_NHRVS <- rename(thesis_NHRVS,
      MET_total = godin_total_ac,
      God_mild = godin_mild_winsor,
      God_mod = godin_Mod_winsor,
      God_stren = godin_Stren_winsor,
      College = SomeCollege_or_Higher,
      MCS = MCS_FINAL,
      PCS = PCS_FINAL,
      Arthritis = Q22A_1,
      Athsma =  Q22A_2,
      Cancer = Q22A_3,
      Chron_pain = Q22A_4,
      Liv_dis = Q22A_5,
      Diabetes = Q22A_6,
      Hrt_dis = Q22A_7,
      Hrt_atk = Q22A_8,
      High_chol = Q22A_9,
      High_bld_press = Q22A_10,
      Kid_dis = Q22A_11,
      Migrane = Q22B_1,
      MS = Q22B_2,
      Osteoporosis = Q22B_3,
      Rhum_arth = Q22B_4,
      Stroke = Q22B_5,
      PTSD_Current = PM_PCL_31,
      MDD_Current = MDD_POSITIVE_CURRENT,
      GAD_Current = GAD_POSITIVE_CURRENT,
      SI_Current = SI_CURRENT,
      AUD_Current = AUD_CURRENT,
      DUD_Current = DUD_CURRENT,
      Concussion_current = Concussion_PosScreen
)
# We need exercsie variables that are in MET minutes, not just HCS. 
# We also need to create demographic and health variables

thesis_NHRVS<- thesis_NHRVS %>%
  # First Create all of the variables
  mutate(thesis_NHRVS, 
    # Exercise variables
         Ex_time = (God_mild + God_mod + God_stren)*15,
            # Tells us how long people exercised for.
         MET_min = MET_total* 15,
         MET_min_W = ifelse(MET_min > 2500, 2500, MET_min),
            # Total METs per week times the duration of exercise
         Ex_rec = as.factor(ifelse(MET_min >= 500, "Sufficient", "Inufficient")),
            # Meeting activity levels (i.e., sufficient vs insufficient)
         Ex_3cat = as.factor(ifelse(MET_min < 290, 1,
                              ifelse(MET_min < 500 & MET_min >= 290, 2,3))),
         Ex_4cats = as.factor(ifelse(MET_min < 290, "Sed",
                              ifelse(MET_min < 500 & MET_min >= 290, "Mod",
                              ifelse(MET_min < 1000 & MET_min >= 500, "Active", 
                              ifelse(MET_min < 2000 & MET_min >= 1000, "Super", NA))))),
         Ex_3catW = as.factor(ifelse(MET_min_W < 290, 1,
                              ifelse(MET_min_W < 500 & MET_min_W >= 290, 2,3))),
         Ex_4catsW = as.factor(ifelse(MET_min_W < 290, "Sed",
                              ifelse(MET_min_W < 500 & MET_min_W >= 290, "Mod",
                              ifelse(MET_min_W < 1000 & MET_min_W >= 500, "Active", 
                              ifelse(MET_min_W < 2500 & MET_min_W >= 1000, "Super", NA))))),
# 3 godin (HCS) categories converted to MET_min 
    # Other Variables 
         HCS_win = (God_mod*5) + (God_stren*9),
         HCS3cat = as.factor(ifelse(HCS_win < 14, "Insufficient",
                              ifelse(HCS_win < 24 & HCS_win >= 290, "Moderate", "Active"))),
         Yr5_Military = as.factor(ifelse(Years_in_Military >= 5, "5+", "<5")),
         Active_PA = as.factor(ifelse(Ex_3cat == 3,1,0)),
         Moderate_PA = as.factor(ifelse(Ex_3cat == 2,1,0)),
         Insuf_PA = as.factor(ifelse(Ex_3cat == 2,1,0)),
         Total_HC = Any_Disability + Arthritis + Cancer + Chron_pain + Liv_dis +
                    Diabetes + Hrt_dis + Hrt_atk + High_chol + High_bld_press +
                    Kid_dis + Migrane + MS + Osteoporosis + Rhum_arth + Stroke +
                    PTSD_Current + MDD_Current + GAD_Current + AUD_Current + DUD_Current,
         Total_PHC = Any_Disability + Arthritis + Cancer + Chron_pain + Liv_dis +
                    Diabetes + Hrt_dis + Hrt_atk + High_chol + High_bld_press +
                    Kid_dis + Migrane + MS + Osteoporosis + Rhum_arth + Stroke,
         Total_MHC = PTSD_Current + MDD_Current + GAD_Current + AUD_Current + DUD_Current,
         No_Condition = ifelse(Any_MHC == 1 | Any_PHC ==1, 0,1)
    
    ) %>%
mutate(thesis_NHRVS,
      #Physical health variables
           Any_Disability = as.factor(Any_Disability),
           Arthritis = as.factor(Arthritis),
           Athsma = as.factor(Athsma),
           Cancer = as.factor(Cancer),
           Chron_pain = as.factor(Chron_pain),
           Liv_dis = as.factor(Liv_dis),
           Diabetes = as.factor(Diabetes),
           Hrt_dis = as.factor(Hrt_dis),
           Hrt_atk = as.factor(Hrt_atk),
           High_chol = as.factor(High_chol),
           High_bld_press = as.factor(High_bld_press),
           Kid_dis = as.factor(Kid_dis),
           Migrane = as.factor(Migrane),
           MS = as.factor(MS),
           Osteoporosis = as.factor(Osteoporosis),
           Rhum_arth = as.factor(Rhum_arth),
           Stroke = as.factor(Stroke),
           Ex_3cat = as.factor(Ex_3cat),  
           Male_Gender = as.factor(Male_Gender), 
           Married_Partnered = as.factor(Married_Partnered),
           White_Race = as.factor(White_Race),
           College = as.factor(College),
           Income_60k_plus = as.factor(Income_60k_plus),
           YN_work = as.factor(YN_work),
           Combat_Veteran = as.factor(Combat_Veteran),
           Any_MHC = as.factor(Any_MHC),
           Any_PHC = as.factor(Any_PHC),
           god2cat = as.factor(god2cat),
      #Mental health variables
          PTSD_Current = as.factor(PTSD_Current),
          MDD_Current = as.factor(MDD_Current),
          GAD_Current = as.factor(GAD_Current),
          # SI_Current = SI_CURRENT,
          AUD_Current = as.factor(AUD_Current),
          DUD_Current = as.factor(DUD_Current),
    )
thesis_NHRVS <- mutate(thesis_NHRVS, 
        Ex_3cat = recode(Ex_3cat,
                         "1" = "Insufficient",
                         "2" = "Moderate",
                         "3" = "Active"),
        Married_Partnered = recode(Married_Partnered,
                         "0" = "Married_Partnered",
                         "1" = "Single"),
        Male_Gender = as.factor(Male_Gender),
        Male_Gender = recode(Male_Gender,
                         "0" = "Female",
                         "1" = "Male"),
        White_Race = recode(White_Race,
                         "0" = "Not_White",
                         "1" = "White"),
        College = recode(College,
                         "0" = "No_Colege",
                         "1" = "Some_Colege"),
        Income_60k_plus = recode(Income_60k_plus,
                         "0" = "Under_60k",
                         "1" = "OVer_60k"),
        YN_work = recode(YN_work,
                         "1" = "No_Work",
                         "2" = "Working"),
        Combat_Veteran = as.factor(Combat_Veteran),
        Combat_Veteran = recode(Combat_Veteran,
                         "0" = "No_Combat",
                         "1" = "Combat"),
        Any_MHC = recode(Any_MHC,
                         "0" = "No_con",
                         "1" = "MHC"),
        Any_PHC = recode(Any_PHC,
                         "0" = "No_con",
                         "1" = "PHC"))

#Filter out NA values
thesis_NHRVS <- thesis_NHRVS %>%
  filter(!is.na(Ex_rec)) %>%
  filter(!is.na(Ex_3cat)) %>%
  filter(!is.na(MCS)) %>%
  filter(!is.na(PCS)) %>%
  filter(!is.na(BMI)) %>%
  filter(!is.na(Any_Disability)) %>%
  filter(!is.na(Arthritis)) %>%
  filter(!is.na(Cancer)) %>%
  filter(!is.na(Chron_pain)) %>%
  filter(!is.na(Liv_dis)) %>%
  filter(!is.na(Diabetes)) %>%
  filter(!is.na(Hrt_dis)) %>%
  filter(!is.na(Hrt_atk)) %>%
  filter(!is.na(High_chol)) %>%
  filter(!is.na(High_bld_press)) %>%
  filter(!is.na(Kid_dis)) %>%
  filter(!is.na(Migrane)) %>%
  filter(!is.na(MS)) %>%
  filter(!is.na(Osteoporosis)) %>%
  filter(!is.na(Rhum_arth)) %>%
  filter(!is.na(Stroke)) %>%
  filter(!is.na(MDD_Current)) %>%
  filter(!is.na(PTSD_Current)) %>%
  filter(!is.na(AUD_Current)) %>%
  filter(!is.na(DUD_Current)) %>%
  filter(!is.na(GAD_Current)) 
#$View(thesis_NHRVS)
thesis_NHRVS

```
```{r}
# str(NHRVS_2019$Race_4Cat)
# tab<-table(NHRVS_2019$Race_4Cat)
# tab<- (tab[1:4]/length(NHRVS_2019$Race_4Cat))*100
# tab

str(thesis_NHRVS$Ex_rec)
```



# Create Data frames
This first set of code is used to create the dataframes needed for our analysis. 
Once the data frame is made, then we can use the function below to add values to 
the data frames.
```{r}
variable    = 0
  statistic = 0
  estimate  = 0
  conf.low  = 0
  conf.high = 0
  ci        = 0
  p.value   = 0
  r2_change = 0
#   
# # Multinomial 
# 
#   Ins_Mod_Uni <- data.frame(cbind(variable,statistic,estimate,conf.low,conf.high,ci,p.value,r2_change))[1,]
#   Ins_Act_Uni <- data.frame(cbind(variable,statistic,estimate,conf.low,conf.high,ci,p.value,r2_change))[1,]
#   Act_Mod_Uni <- data.frame(cbind(variable,statistic,estimate,conf.low,conf.high,ci,p.value,r2_change))[1,]
#   
# # Block 1 Covars - SF8
# 
#   Ins_Mod_Cov <- data.frame(cbind(variable,statistic,estimate,conf.low,conf.high,ci,p.value,r2_change))[1,]
#   Ins_Act_Cov <- data.frame(cbind(variable,statistic,estimate,conf.low,conf.high,ci,p.value,r2_change))[1,]
#   Act_Mod_Cov <- data.frame(cbind(variable,statistic,estimate,conf.low,conf.high,ci,p.value,r2_change))[1,]
#   
# # Block 2 Covars + SF8
#   
#   Ins_Mod_SF8 <- data.frame(cbind(variable,statistic,estimate,conf.low,conf.high,ci,p.value,r2_change))[1,]
#   Ins_Act_SF8 <- data.frame(cbind(variable,statistic,estimate,conf.low,conf.high,ci,p.value,r2_change))[1,]
#   Act_Mod_SF8 <- data.frame(cbind(variable,statistic,estimate,conf.low,conf.high,ci,p.value,r2_change))[1,]
# 
# # Block 3 Full Model
#   Ins_Mod  <- data.frame(cbind(variable,statistic,estimate,conf.low,conf.high,ci,p.value,r2_change))[1,]
#   Ins_Act  <- data.frame(cbind(variable,statistic,estimate,conf.low,conf.high,ci,p.value,r2_change))[1,]
#   Act_Mod  <- data.frame(cbind(variable,statistic,estimate,conf.low,conf.high,ci,p.value,r2_change))[1,]
```

# Preliminary Regression: Univariate Regression function

The first step in my analysis was to run the multinomial regressions without covariates so I can see how the health conditions are associated with physical activity level independent of covariates. The following `UniThesis()` function does the following:

1. Runs the multinomial models using `multinom()`
2. Manually calculates the coefficients _B_, the odds ratios (OR) + 95% Confideince interval (95% CI), and _p_ values
3. Extracts respective values for each type of comparison (e.g., sufficiently active vs moderatly active)
4. Returns respective values as a row in a data frame which can be compiled into a larger data frame per comparison

# Step Wise Multivariate Logistic Multinomial Regression
That's a mouthful! For the following section we will be running code for the full regression model, The blocks of this regession are as follows:

1. Covariates: Sociodemograpahic, military, and health variables
2. Physical health conditions
3. Mental Health Conditions

## Regession Code {.tabset}

### Block 1: Covariates
This first block of the stepwise regression will do the same thing as we did for the univariate analysis, being that this was not replicated we did not make a function for it.



```{r,warning=FALSE,message=FALSE,results='hide'}
######### PICK UP HERE ###########
# age, gender, race, educational attainment, relationship status, and income), PCS scores, number of lifetime potentially traumatic events, and combat veteran status

### Part 1 Create values for table
#1. Run the models


Cov_Reg<-glm(Ex_rec~ + Age + College + White_Race  + Income_60k_plus + Combat_Veteran + 
                           TOTAL_TRAUMAS + BMI, data= thesis_NHRVS,family="binomial") 
  

Cov_Reg_sum <- summary(Cov_Reg)
Cov_Reg_sum <- tidy(Cov_Reg) 

#2. Coefficients 
  coefs_Cov_Reg <- abs(coef(Cov_Reg))
  coefs_Cov_Reg 
#3. Odds ratio
  OR_Cov_Reg <- exp(coef(Cov_Reg))

#4. OR 95% CI
  CI_Cov_Reg <- data.frame(round(exp(confint(Cov_Reg)),2))

#5. P values 
  p_val1<- cbind(Cov_Reg_sum$term ,Cov_Reg_sum$p.value)
    adj.p <- FDR(pvalues = p_val1)
    ADJ.p.values <- data.frame(rbind(adj.p$exclude, adj.p$select))
    ADJ.p.values
    
#6. R^2 for model
  R2_Cov_Reg <- performance::r2(Cov_Reg)

#wald

  cov_wald<- wald.test(b = coef(Cov_Reg),Sigma = vcov(Cov_Reg),Terms= 2:7)
  cov_wald$result$chi2[1]
  wald <- wald.test(b = coef(Cov_Reg),Sigma = vcov(Cov_Reg),Terms=2)$result$chi2[1]
  for(i in 3:7){
      wald <- append(wald, wald.test(b = coef(Cov_Reg),Sigma = vcov(Cov_Reg),Terms=i)$result$chi2[1])
  }
  wald
#### Part 2. Make the table and export 

#1. Create data frame
cov_OR_df <-  data.frame(cbind(
  variable = Cov_Reg_sum$term[2:length(Cov_Reg_sum$term)],
  Beta = coefs_Cov_Reg[2:length(Cov_Reg_sum$term)],
  Wald = round(wald,2),
  OR = OR_Cov_Reg[2:length(OR_Cov_Reg)],
  CI = paste0("[",CI_Cov_Reg[2:length(OR_Cov_Reg),1], ",", CI_Cov_Reg[2:length(OR_Cov_Reg),2], "]"),
  p = p_val1[2:7,2]
))


cov_OR_df  <- left_join(cov_OR_df, ADJ.p.values,by = join_by(p == p.value))
cov_OR_tab <- data.frame(cbind(
  variable = cov_OR_df$variable,
  Beta = cov_OR_df$Beta,
  Wald = cov_OR_df$Wald,
  OR = cov_OR_df$OR,
  CI = cov_OR_df$CI,
  p = cov_OR_df$p.adjusted
))

cov_OR_tab$Beta = round(as.numeric(cov_OR_tab$Beta),2)
cov_OR_tab$Wald = round(as.numeric(cov_OR_tab$Wald),2)
cov_OR_tab$OR = round(as.numeric(cov_OR_tab$OR),2)
cov_OR_tab$p = ifelse(as.numeric(cov_OR_df$p) < 0.001, "< 0.001",
  round(as.numeric(cov_OR_df$p),2))

#2. create the row for the R2
  paste("Block 1 R^2 =", round((R2_Cov_Reg[[1]]*100),3),"%")
  variable = c(
    paste0("Block 1 X^2=", round(cov_wald$result$chi2[1],2),",p<0.001"),
    paste0("Block 1 R^2=", round((R2_Cov_Reg[[1]]),3))  
  )



  R2TAB<-data.frame(cbind(
                      variable,Beta=NA,Wald=NA, OR =NA, CI=NA, p=NA))

#3. Bind the stuff together
  cov_OR_tab <- rbind(R2TAB, cov_OR_tab)
cov_OR_tab
#4. Export
  # write_csv(cov_OR_tab,"~/Desktop/Coding/data/EX_C_cov_OR_tab.csv")
```
```{r}
  knitr::kable(cov_OR_tab) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

### Full Model Function

The final step in my analysis was to run the full multinomial model so I can see how the health conditions are associated with physical activity level after controling for covariates. The following `MultiThesis()` function does the following 
1. Runs the 2 different multinomial models using [multinom()](https://www.rdocumentation.org/packages/nnet/versions/7.3-18/topics/multinom)
    + Physical health condtions include the MCS
    + Mental health conditions include the PCS
2. Manually calculates the coefficients _B_, the odds ratios (OR) + 95% Confideince interval (95% CI), and _p_ values
3. Extracts respective values for each type of comparison (e.g., sufficiently active vs moderatly active)
4. Returns respective values as a row in a dataframe which can be compiled into a larger data fram per comparison


Make a function to run a chi2 and save the output for all physical health conditions
```{r}
Condition_eval<-function(condition,string){
  chi2 <- xtabs(~thesis_NHRVS$Ex_rec + condition)
  output <- data.frame(cbind(
    variable = string, 
    chi2 = summary(chi2)[[3]], 
    p = summary(chi2)[[6]]
  ))
  return(output)
}
```


Run the chi2 function to get an output of what variables we should include in our regression model
```{r,include=FASLSE}
#1. run model 1
Conditions_chi<-data.frame(Condition_eval(thesis_NHRVS$Arthritis,"Arthritis"))
#3. Asthma
Conditions_chi<-rbind(Conditions_chi,Condition_eval(thesis_NHRVS$Athsma,"Athsma"))
#4. Cancer
Conditions_chi<-rbind(Conditions_chi,Condition_eval(thesis_NHRVS$Cancer,"Cancer"))
#5. Chronic Pain
Conditions_chi<-rbind(Conditions_chi,Condition_eval(thesis_NHRVS$Chron_pain,"Chronic Pain"))
#6. Diabetes
Conditions_chi<-rbind(Conditions_chi,Condition_eval(thesis_NHRVS$Diabetes,"Diabetes"))
#7. Heart Attack
Conditions_chi<-rbind(Conditions_chi,Condition_eval(thesis_NHRVS$Hrt_atk,"Heart Attack"))
#8. Heart Disease
Conditions_chi<-rbind(Conditions_chi,Condition_eval(thesis_NHRVS$Hrt_dis,"Heart Disease"))
#9. High Cholesterol
Conditions_chi<-rbind(Conditions_chi,Condition_eval(thesis_NHRVS$High_chol,"High Cholesterol"))
#10. Hypertension
Conditions_chi<-rbind(Conditions_chi,Condition_eval(thesis_NHRVS$High_bld_press,"Hypertension"))
#11. Kidney Disease
Conditions_chi<-rbind(Conditions_chi,Condition_eval(thesis_NHRVS$Kid_dis,"Kidney Disease"))
#12. Liver Disease
Conditions_chi<-rbind(Conditions_chi,Condition_eval(thesis_NHRVS$Liv_dis,"Liver Disease"))
#13. Migrane
Conditions_chi<-rbind(Conditions_chi,Condition_eval(thesis_NHRVS$Migrane,"Migrane"))
#14. MS
Conditions_chi<-rbind(Conditions_chi,Condition_eval(thesis_NHRVS$MS,"MS"))
#15. Osteoporosis
Conditions_chi<-rbind(Conditions_chi,Condition_eval(thesis_NHRVS$Osteoporosis,"Osteoporosis"))
#16. Rheumatoid Arthritis
Conditions_chi<-rbind(Conditions_chi,Condition_eval(thesis_NHRVS$Rhum_arth,"RA"))
#17. Stroke
Conditions_chi<-rbind(Conditions_chi,Condition_eval(thesis_NHRVS$Stroke,"Stroke"))
# ### Mental Health Conditions
#18. Alcohol Use Disorder
Conditions_chi<-rbind(Conditions_chi,Condition_eval(thesis_NHRVS$AUD_Current,"AUD"))
#19. Drug Use Disorder
Conditions_chi<-rbind(Conditions_chi,Condition_eval(thesis_NHRVS$DUD_Current,"DUD"))
#20. Major Depressive Disorder
Conditions_chi<-rbind(Conditions_chi,Condition_eval(thesis_NHRVS$MDD_Current,"MDD"))
#22 Posttraumatic Stress Disorder
Conditions_chi<-rbind(Conditions_chi,Condition_eval(thesis_NHRVS$PTSD_Current,"PTSD"))
#23 Generalized Anxiety Disorder
Conditions_chi<-rbind(Conditions_chi,Condition_eval(thesis_NHRVS$GAD_Current,"GAD"))
```

Create a variable which selects significant health conditions to be used in the multivaraible regression model
```{r}
Conditions_X_use <- Conditions_chi |>
  mutate(
    p = as.numeric(p),
    sig = ifelse(
      as.numeric(Conditions_chi$p) < 0.05, 1, 0)
  )|>
  filter(
    sig == 1
  )

Conditions_X_use
```


```{r,include=FALSE}
# 
# #1. run model 1
#   df <- glm(Ex_rec  ~  Age + College + White_Race  + Income_60k_plus + Combat_Veteran + 
#                            TOTAL_TRAUMAS + BMI, data = thesis_NHRVS,family="binomial")
#   
# #2. summary of the model
#   df_summary <- summary(df)
#   df_sum <- tidy(df) 
# #4 Coefficients 
#   coefs_df <- abs(coef(df))
# #5. Odds ratio
#   OR_df <- exp(coef(df))
# #6. OR 95% CI
#   CI_df <- data.frame(round(exp(confint(df)),2))
# #7. P value function
#   p_val1<- cbind(df_sum$term ,df_sum$p.value)
#   adj.p <- FDR(pvalues = p_val1)
#   ADJ.p.values <- data.frame(rbind(adj.p$exclude, adj.p$select))
#   ADJ.p.values
# 
# #### Part 2. Make the table and export   
#   
# #1. Create a data frame
# tab_df <-  data.frame(cbind(
#   variable = df_sum$term[2:length(df_sum$term)],
#   Beta = coefs_df[2:length(df_sum$term)],
#   Wald = round(wald,2),
#   OR = OR_df[2:length(OR_df)],
#   CI = paste0("[",CI_df[2:length(OR_df),1], ",", CI_df[2:length(OR_df),2], "]"),
#   p = p_val1[2:length(length(p_val1[,2])),2]
# ))
# #2. left join adjusted p values
# #tab_df  <- left_join(tab_df, ADJ.p.values,by = join_by(p == p.value))
# 
# #3. 
# tab_tab <- data.frame(cbind(
#   variable = tab_df$variable,
#   Beta = tab_df$Beta,
#   Wald = tab_df$Wald,
#   OR = tab_df$OR,
#   CI = tab_df$CI,
#   p = tab_df$p
# ))
# #round the numbers
# tab_tab$Beta = round(as.numeric(tab_tab$Beta),2)
# tab_tab$Wald = round(as.numeric(tab_tab$Wald),2)
# tab_tab$OR = round(as.numeric(tab_tab$OR),2)
# tab_tab$p = tab_tab$p = round(as.numeric(tab_tab$p),4)
# 
# tab_tab[1,1] = string
# 
# output <- tab_tab[1,]
#   
#   return(output)
# }


```


For fun, Lets run some regressions with the output to see if the covariates interact with these conditions.
```{r}
# Multivariate Logistic Multinomial Regression Function

Condition_eval_Reg<-function(Data,condition,string){

#1. run model 1
  df <- glm(Ex_rec  ~ condition + Age + College + White_Race  + Income_60k_plus + Combat_Veteran + 
                           TOTAL_TRAUMAS + BMI, data = Data,family="binomial")
  
#2. summary of the model
  df_summary <- summary(df)
  df_sum <- tidy(df) 
#4 Coefficients 
  coefs_df <- abs(coef(df))
#5. Odds ratio
  OR_df <- exp(coef(df))
#6. OR 95% CI
  CI_df <- data.frame(round(exp(confint(df)),2))
#7. P value function
  p_val1<- cbind(df_sum$term ,df_sum$p.value)
  adj.p <- FDR(pvalues = p_val1)
  ADJ.p.values <- data.frame(rbind(adj.p$exclude, adj.p$select))
  ADJ.p.values

#### Part 2. Make the table and export   
  
#1. Create a data frame
tab_df <-  data.frame(cbind(
  variable = df_sum$term[2:length(df_sum$term)],
  Beta = coefs_df[2:length(df_sum$term)],
  Wald = round(wald,2),
  OR = OR_df[2:length(OR_df)],
  CI = paste0("[",CI_df[2:length(OR_df),1], ",", CI_df[2:length(OR_df),2], "]"),
  p = p_val1[2:length(length(p_val1[,2])),2]
))
#2. left join adjusted p values
#tab_df  <- left_join(tab_df, ADJ.p.values,by = join_by(p == p.value))

#3. 
tab_tab <- data.frame(cbind(
  variable = tab_df$variable,
  Beta = tab_df$Beta,
  Wald = tab_df$Wald,
  OR = tab_df$OR,
  CI = tab_df$CI,
  p = tab_df$p
))
#round the numbers
tab_tab$Beta = round(as.numeric(tab_tab$Beta),2)
tab_tab$Wald = round(as.numeric(tab_tab$Wald),2)
tab_tab$OR = round(as.numeric(tab_tab$OR),2)
tab_tab$p = tab_tab$p = round(as.numeric(tab_tab$p),4)

tab_tab[1,1] = string

output <- tab_tab[1,]
  
  return(output)
}
#Its done!
```


```{r,include=FALS}
### Physical Health Conditions 
# Conditions_reg = 0

#2. Arthritis
Conditions_reg<-data.frame(Condition_eval_Reg(thesis_NHRVS,thesis_NHRVS$Arthritis,"Arthritis"))
#3. Asthma
Conditions_reg<-rbind(Conditions_reg,Condition_eval_Reg(thesis_NHRVS,thesis_NHRVS$Athsma,"Athsma"))
#4. Cancer
Conditions_reg<-rbind(Conditions_reg,Condition_eval_Reg(thesis_NHRVS,thesis_NHRVS$Cancer,"Cancer"))
#5. Chronic Pain
Conditions_reg<-rbind(Conditions_reg,Condition_eval_Reg(thesis_NHRVS,thesis_NHRVS$Chron_pain,"Chronic Pain"))
#6. Diabetes
Conditions_reg<-rbind(Conditions_reg,Condition_eval_Reg(thesis_NHRVS,thesis_NHRVS$Diabetes,"Diabetes"))
#7. Heart Attack
Conditions_reg<-rbind(Conditions_reg,Condition_eval_Reg(thesis_NHRVS,thesis_NHRVS$Hrt_atk,"Heart Attack"))
#8. Heart Disease
Conditions_reg<-rbind(Conditions_reg,Condition_eval_Reg(thesis_NHRVS,thesis_NHRVS$Hrt_dis,"Heart Disease"))
#9. High Cholesterol
Conditions_reg<-rbind(Conditions_reg,Condition_eval_Reg(thesis_NHRVS,thesis_NHRVS$High_chol,"High Cholesterol"))
#10. Hypertension
Conditions_reg<-rbind(Conditions_reg,Condition_eval_Reg(thesis_NHRVS,thesis_NHRVS$High_bld_press,"Hypertension"))
#11. Kidney Disease
Conditions_reg<-rbind(Conditions_reg,Condition_eval_Reg(thesis_NHRVS,thesis_NHRVS$Kid_dis,"Kidney Disease"))
#12. Liver Disease
Conditions_reg<-rbind(Conditions_reg,Condition_eval_Reg(thesis_NHRVS,thesis_NHRVS$Liv_dis,"Liver Disease"))
#13. Migrane
Conditions_reg<-rbind(Conditions_reg,Condition_eval_Reg(thesis_NHRVS,thesis_NHRVS$Migrane,"Migrane"))
#14. MS
Conditions_reg<-rbind(Conditions_reg,Condition_eval_Reg(thesis_NHRVS,thesis_NHRVS$MS,"MS"))
#15. Osteoporosis
Conditions_reg<-rbind(Conditions_reg,Condition_eval_Reg(thesis_NHRVS,thesis_NHRVS$Osteoporosis,"Osteoporosis"))
#16. Rheumatoid Arthritis
Conditions_reg<-rbind(Conditions_reg,Condition_eval_Reg(thesis_NHRVS,thesis_NHRVS$Rhum_arth,"RA"))
#17. Stroke
Conditions_reg<-rbind(Conditions_reg,Condition_eval_Reg(thesis_NHRVS,thesis_NHRVS$Stroke,"Stroke"))
### Mental Health Conditions
#18. Alcohol Use Disorder
Conditions_reg<-rbind(Conditions_reg,Condition_eval_Reg(thesis_NHRVS,thesis_NHRVS$AUD_Current,"AUD"))
#19. Drug Use Disorder
Conditions_reg<-rbind(Conditions_reg,Condition_eval_Reg(thesis_NHRVS,thesis_NHRVS$DUD_Current,"DUD"))
#20. Major Depressive Disorder 
Conditions_reg<-rbind(Conditions_reg,Condition_eval_Reg(thesis_NHRVS,thesis_NHRVS$MDD_Current,"MDD"))
#22 Posttraumatic Stress Disorder
Conditions_reg<-rbind(Conditions_reg,Condition_eval_Reg(thesis_NHRVS,thesis_NHRVS$PTSD_Current,"PTSD"))
#23 Generalized Anxiety Disorder
Conditions_reg<-rbind(Conditions_reg,Condition_eval_Reg(thesis_NHRVS,thesis_NHRVS$GAD_Current,"GAD"))
```

```{r}
Conditions_R_use <- Conditions_reg |>
  mutate(
    signifcant = ifelse(
      as.numeric(p) < 0.05, 1, 0)
    ) |>
  filter(
    signifcant == 1
  )

Conditions_R_use
```



### Block 2: Physical Health Conditions
Block to is idential to block one with the addition of the MCS and PCS to the regression model. We are running two different regession models (i.e., one with the MCS and one with the PCS) so you can see that below. 
```{r,warning=FALSE,message=FALSE,results='hide'}
### Part 1 Physical health conditions for table
#1. Run the models
PHC_Reg<-glm(Ex_rec~
             #Covariates
             Age + College + White_Race  +
             Income_60k_plus + Combat_Veteran + 
             TOTAL_TRAUMAS + BMI +
             #Physical Health Conditions
             Athsma + Chron_pain + Diabetes+ Hrt_atk + 
             Hrt_dis + High_chol + High_bld_press + Osteoporosis + Stroke,
             #Mental Health conditions
             # AUD_Current + DUD_Current + MDD_Current + PTSD_Current + GAD_Current,
             # Data
             data =thesis_NHRVS,
             # Specify type of regression
             family="binomial",weights = weight)


summary(PHC_Reg)
PHC_Reg_sum <- tidy(PHC_Reg) 

#2. Coefficients 
  coefs_PHC_Reg <- abs(coef(PHC_Reg))
  coefs_PHC_Reg
#3. Odds ratio
  OR_PHC_Reg <- exp(coef(PHC_Reg)[9:length(coefs_PHC_Reg)])

#4. OR 95% CI
  CI_PHC_Reg <- data.frame(round(exp(confint(PHC_Reg)[9:length(coefs_PHC_Reg),]),2))

#5. P values 
  p_val1<- cbind(PHC_Reg_sum$term[9:length(coefs_PHC_Reg)], 
                 PHC_Reg_sum$p.value[9:length(coefs_PHC_Reg)])
    adj.p <- FDR(pvalues = p_val1)
    ADJ.p.values <- data.frame(rbind(adj.p$exclude, adj.p$select))
    ADJ.p.values
    
#6. R^2 for model
  R2_PHC_Reg <- performance::r2(PHC_Reg) 
  block_2_R2 = R2_PHC_Reg[[1]] - R2_Cov_Reg[[1]]
#wald
  library(aod) # Wald test
  PHC_wald<- wald.test(b = coef(PHC_Reg),Sigma = vcov(PHC_Reg),Terms= 2:length(coefs_PHC_Reg))
  PHC_wald$result$chi2[1]
  wald <- wald.test(b = coef(PHC_Reg),Sigma = vcov(PHC_Reg),Terms=9)$result$chi2[1]
  for(i in 10:length(coefs_PHC_Reg)){
      wald <- append(wald, wald.test(b = coef(PHC_Reg),Sigma = vcov(PHC_Reg),Terms=i)$result$chi2[1])
  }
#### Part 2. Make the table and export 

#1. Create data frame
PHC_Reg_df <-  data.frame(cbind(
  variable = PHC_Reg_sum$term[9:length(PHC_Reg_sum$term)],
  Beta = coefs_PHC_Reg[9:length(coefs_PHC_Reg)],
  Wald = round(wald,2),
  OR = OR_PHC_Reg,
  CI = paste0("[",CI_PHC_Reg[,1], ",", CI_PHC_Reg[,2], "]"),
  p = p_val1[,2]
))

PHC_Reg_df  <- left_join(PHC_Reg_df, ADJ.p.values,by = join_by(p == p.value))
PHC_Reg_tab <- data.frame(cbind(
  variable = PHC_Reg_df$variable,
  Beta = PHC_Reg_df$Beta,
  Wald = PHC_Reg_df$Wald,
  OR = PHC_Reg_df$OR,
  CI = PHC_Reg_df$CI,
  p = PHC_Reg_df$p
  # p = PHC_Reg_df$p.adjusted
))

PHC_Reg_df 

PHC_Reg_tab$Beta = round(as.numeric(PHC_Reg_tab$Beta),2)
PHC_Reg_tab$Wald = round(as.numeric(PHC_Reg_tab$Wald),2)
PHC_Reg_tab$OR = round(as.numeric(PHC_Reg_tab$OR),2)
PHC_Reg_tab$p = ifelse(as.numeric(PHC_Reg_df$p) < 0.001, "< 0.001",
  round(as.numeric(PHC_Reg_df$p),2))

#2. create the row for the R2
  paste("Block 2 R^2 =", round((R2_PHC_Reg[[1]]*100),3),"%")
  variable = c(
    paste0("Block 2 X^2=", round(PHC_wald$result$chi2[1],2),",p<0.001"),
    paste0("Block 2 R^2 change=", round((block_2_R2[[1]]),3))  
  )

  R2TAB<-data.frame(cbind(
                      variable,Beta=NA,Wald=NA, OR =NA, CI=NA, p=NA))

#3. Bind the stuff together
  PHC_Reg_tab <- rbind(R2TAB, PHC_Reg_tab)
  Full_OR_tab <- rbind(cov_OR_tab,PHC_Reg_tab)

#4. Export
  # write_csv(PHC_Reg_tab,"~/Desktop/Coding/data/PHC_Reg_tab.csv")
  # write_csv(Full_OR_tab, "~/Desktop/Coding/data/EX_Full_OR_tab.csv")
  
  PHC_Reg_tab

```
```{r}
  knitr::kable(Full_OR_tab) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

block 3 - mental health conditions
```{r}
MHC_Reg<-glm(Ex_rec~
             #Covariates
             Age + College + White_Race  +
             Income_60k_plus + Combat_Veteran + 
             TOTAL_TRAUMAS + BMI +
             #Physical Health Conditions
             Athsma + Chron_pain + Diabetes+ Hrt_atk + 
             Hrt_dis + High_chol + High_bld_press + Osteoporosis + Stroke +
             #Mental Health conditions
             AUD_Current + DUD_Current + GAD_Current + MDD_Current + PTSD_Current,
             # Data
             data =thesis_NHRVS,
             # Specify type of regression
             family="binomial",weights = weight)


summary(MHC_Reg)
MHC_Reg_sum <- tidy(MHC_Reg) 

#2. Coefficients 
  coefs_MHC_Reg <- abs(coef(MHC_Reg))
  coefs_MHC_Reg
#3. Odds ratio
  OR_MHC_Reg <- exp(coef(MHC_Reg)[18:length(coefs_MHC_Reg)])

#4. OR 95% CI
  CI_MHC_Reg <- data.frame(round(exp(confint(MHC_Reg)[18:length(coefs_MHC_Reg),]),2))

#5. P values 
  p_val1<- cbind(MHC_Reg_sum$term[18:length(coefs_MHC_Reg)], 
                 MHC_Reg_sum$p.value[18:length(coefs_MHC_Reg)])
    adj.p <- FDR(pvalues = p_val1)
    ADJ.p.values <- data.frame(rbind(adj.p$exclude, adj.p$select))
    ADJ.p.values
    
#6. R^2 for model
  R2_MHC_Reg <- performance::r2(MHC_Reg)
  Block3_R2 = R2_MHC_Reg[[1]] - block_2_R2[[1]]

#wald
  library(aod) # Wald test
  MHC_wald<- wald.test(b = coef(MHC_Reg),Sigma = vcov(MHC_Reg),Terms= 2:length(coefs_MHC_Reg))
  MHC_wald$result$chi2[1]
  wald <- wald.test(b = coef(MHC_Reg),Sigma = vcov(MHC_Reg),Terms=18)$result$chi2[1]
  for(i in 19:length(coefs_MHC_Reg)){
      wald <- append(wald, wald.test(b = coef(MHC_Reg),Sigma = vcov(MHC_Reg),Terms=i)$result$chi2[1])
  }
  MHC_wald
#### Part 2. Make the table and export 

#1. Create data frame
MHC_Reg_df <-  data.frame(cbind(
  variable = MHC_Reg_sum$term[18:length(MHC_Reg_sum$term)],
  Beta = coefs_MHC_Reg[18:length(coefs_MHC_Reg)],
  Wald = round(wald,2),
  OR = OR_MHC_Reg,
  CI = paste0("[",CI_MHC_Reg[,1], ",", CI_MHC_Reg[,2], "]"),
  p = p_val1[,2]
))

MHC_Reg_df  <- left_join(MHC_Reg_df, ADJ.p.values,by = join_by(p == p.value))
MHC_Reg_tab <- data.frame(cbind(
  variable = MHC_Reg_df$variable,
  Beta = MHC_Reg_df$Beta,
  Wald = MHC_Reg_df$Wald,
  OR = MHC_Reg_df$OR,
  CI = MHC_Reg_df$CI,
  p = MHC_Reg_df$p
  # p = MHC_Reg_df$p.adjusted
))

MHC_Reg_df 

MHC_Reg_tab$Beta = round(as.numeric(MHC_Reg_tab$Beta),2)
MHC_Reg_tab$Wald = round(as.numeric(MHC_Reg_tab$Wald),2)
MHC_Reg_tab$OR = round(as.numeric(MHC_Reg_tab$OR),2)
MHC_Reg_tab$p = ifelse(as.numeric(MHC_Reg_df$p) < 0.001, "< 0.001",
  round(as.numeric(MHC_Reg_df$p),3))

#2. create the row for the R2
  variable = c(
    paste0("Block 3 X^2=", round(MHC_wald$result$chi2[1],2),",p<0.001"),
    paste0("Block 3 R^2=", round((Block3_R2[[1]]),3))  
  )

  R2TAB<-data.frame(cbind(
                      variable,Beta=NA,Wald=NA, OR =NA, CI=NA, p=NA))

#3. Bind the stuff together
  MHC_Reg_tab <- rbind(R2TAB, MHC_Reg_tab)
  Full_OR_tab <- rbind(Full_OR_tab,MHC_Reg_tab)

#4. Export
  # write_csv(MHC_Reg_tab,"~/Desktop/Coding/data/MHC_Reg_tab.csv")
  # write_csv(Full_OR_tab, "~/Desktop/Coding/data/EX_Full_OR_tab.csv")
  
  MHC_Reg_tab
  Full_OR_tab
  
  MHC_Reg_df
  
Full_OR_tab$variable = 
  c("Block 1 X^2=83.47,p<0.001","Block 1 R^2=0.047","Age","College",
    "White_Race","Income_60k_plus","Combat_Veteran","TOTAL_TRAUMAS","BMI",
    "Block 2 X^2=83.47,p<0.001","Block 2 R^2 change=0.01", "Athsma",  
    "Chron_pain", "Diabetes", "Hrt_atk", "Hrt_dis", "High_chol", 
    "High_bld_press", "Osteoporosis", "Stroke", "Block 3 X^2=83.47,p<0.001",
    "Block 3 R^2=0.05", "AUD_Current", "DUD_Current", "MDD_Current", 
    "PTSD_Current", "GAD_Current"
    )
```


```{r}
# install.packages("report")
# library(report)
# 
# X <- report(MHC_Reg)

```

## Importance of variables
https://journals-sagepub-com.ezproxy.uky.edu/doi/abs/10.1177/1094428109341993?journalCode=orma

Select data needed for analysis
```{r}
# rawdata<-read.csv("/Users/robertpietrzak/Downloads/DV.csv")
#attach(rawdata)

# thedata<-data.frame(DV, IV1, IV2, IV3)
# thedata <- na.omit(thedata)
# Labels<-names(thedata)[2:length(thedata)]
mydata <- thesis_NHRVS |>
  #Select all of the variables needed for the analysis
  dplyr::select(
    #IV
      Ex_rec,
    #Covariates
       Age,College, White_Race,
       Income_60k_plus, Combat_Veteran,
       TOTAL_TRAUMAS, BMI,
    #Physical Health Conditions
       Athsma, Chron_pain, Diabetes,
       Hrt_atk, Hrt_dis, High_chol,
       High_bld_press, Osteoporosis, Stroke, 
    #Mental Health conditions
       AUD_Current, DUD_Current, GAD_Current,
       MDD_Current, PTSD_Current
  ) |>
    # Convert all of the varaibles to numeric
    mutate(
      Ex_rec = as.numeric(Ex_rec),
      Age = as.numeric(Age),
      College = as.numeric(College),
      White_Race = as.numeric(White_Race),
      Income_60k_plus = as.numeric(Income_60k_plus),
      Combat_Veteran = as.numeric(Combat_Veteran),
      TOTAL_TRAUMAS = as.numeric(TOTAL_TRAUMAS),
      BMI = as.numeric(BMI),
      Athsma = as.numeric(Athsma),
      Chron_pain = as.numeric(Chron_pain), 
      Diabetes = as.numeric(Diabetes),
      Hrt_atk = as.numeric(Hrt_atk), 
      Hrt_dis = as.numeric(Hrt_dis), 
      High_chol = as.numeric(High_chol),
      High_bld_press = as.numeric(High_bld_press), 
      Osteoporosis = as.numeric(Osteoporosis), 
      Stroke = as.numeric(Stroke), 
      AUD_Current = as.numeric(AUD_Current), 
      DUD_Current = as.numeric(DUD_Current), 
      GAD_Current = as.numeric(GAD_Current),
      MDD_Current = as.numeric(MDD_Current), 
      PTSD_Current = as.numeric(PTSD_Current)
    )

mydata <- na.omit(mydata)
```

Functions for bootstrapping
```{r}
logRegress<-function(mydata){
  
numVar<-NCOL(mydata)
Variables<-names(mydata)[2:numVar]
Y<-mydata[,1]
data.preds<-mydata[,2:length(mydata[1,])]
X<-scale(data.preds)


str(X)

X.svd<-svd(X)
Q<-X.svd$v
P<-X.svd$u
Z<-P%*%t(Q)

Z.stand<-scale(Z)

Lambda<-solve(t(Z.stand)%*%Z.stand)%*%t(Z.stand)%*%X #Obtaining Lambda from equation 7 from Johnson (2000) pg 8

logrfit<-glm(as.factor(Y$Ex_rec)~Z.stand,family=binomial)
summary(logrfit)
unstCoefs<-coef(logrfit)
b<-unstCoefs[2:length(unstCoefs)]
LpredY<-predict(logrfit,newdata=mydata,type="response")
lYhat<-log(LpredY/(1-LpredY))#Creating logit-Y-hat
stdlYhat<-sd(lYhat)#Getting stdev of logit-Y-hat
getting.Rsq<-lm(LpredY~as.factor(Y$Ex_rec))#Getting R-sq
Rsq<-summary(getting.Rsq)$r.squared
beta<-b*((sqrt(Rsq))/stdlYhat)#Computing standardized logistic regression coefficients

epsilon<-Lambda^2%*%beta^2
R.sq<<-sum(epsilon)
PropWeights<-(epsilon/R.sq)
result <- data.frame(Variables, Raw.RelWeight=epsilon, Rescaled.RelWeight=PropWeights)
return(result)
}

logBootstrap<-function(mydata, indices){
mydata<-mydata[indices,]
logWeights<-logRegress(mydata)
return(logWeights$Raw.RelWeight)
}

logBootrand<-function(mydata, indices){
mydata<-mydata[indices,]
logRWeights<-logRegress(mydata)
logReps<-logRWeights$Raw.RelWeight
randWeight<-logReps[length(logReps)]
randStat<-logReps[-(length(logReps))]-randWeight
return(randStat)
}

#bootstrapping
#install.packages("boot")


mybootci<-function(x){
boot.ci(logBoot,conf=0.95, type="bca", index=x)
}

runBoot<-function(num){
INDEX<-1:num
test<-lapply(INDEX, FUN=mybootci)
test
test2<-t(sapply(test,'[[',i=4)) #extracts confidence interval
CIresult<<-data.frame(Variables, CI.Lower.Bound=test2[,4],CI.Upper.Bound=test2[,5])
}

myRbootci<-function(x){
boot.ci(logRBoot,conf=0.95,type="bca",index=x)
}

runRBoot<-function(num){
INDEX<-1:num
test<-lapply(INDEX,FUN=myRbootci)
test2<-t(sapply(test,'[[',i=4))
CIresult<<-data.frame(Labels,CI.Lower.Bound=test2[,4],CI.Upper.Bound=test2[,5])
}

  #logRegress(thedata) # perfomed above manually
```


```{r, results='hide'}
#1.1 Run function
result <- logRegress(mydata)

#1.2 save results
RW.Results<-result
RSQ.o<-R.sq



RW.Results <- result |>
  arrange(-Rescaled.RelWeight) |>
  mutate(Rescaled.RelWeight = round((Rescaled.RelWeight*100),2),
         Raw.percent = round(Raw.RelWeight*100,4)
  )
RW.Results

# write_csv(RW.Results,"~/Downloads/RW.Results")
```

Block 1
```{r}
set.seed(123456)

mydata_B1 <- thesis_NHRVS |>
  #Select all of the variables needed for the analysis
  dplyr::select(
    #IV
      Ex_rec,
    #Covariates
       Age,College, White_Race,
       Income_60k_plus, Combat_Veteran,
       TOTAL_TRAUMAS, BMI,
  ) |>
    # Convert all of the varaibles to numeric
    mutate(
      Ex_rec = as.numeric(Ex_rec),
      Age = as.numeric(Age),
      College = as.numeric(College),
      White_Race = as.numeric(White_Race),
      Income_60k_plus = as.numeric(Income_60k_plus),
      Combat_Veteran = as.numeric(Combat_Veteran),
      TOTAL_TRAUMAS = as.numeric(TOTAL_TRAUMAS),
      BMI = as.numeric(BMI),
    )

mydata <- na.omit(mydata)

#2.4 run boot function
logBoot_B1<-boot(mydata_B1, # Data
              logBootstrap, # Statistic
              5000) # R / number of times

#2.5 confidence interval for bootstraps
logci_B1<-boot.ci(logBoot_B1,conf=0.95, type="bca")

boot.ci(logBoot_B1, type="bca",index = 1)

#2.6 runboot function
numVar<-NCOL(mydata_B1)

CI.Result_B1s<- tidy(logBoot_B1,conf.int=TRUE,conf.method="perc") 
CI.Results_B1
write_csv(CI.Results_B1, "~/Downloads/CI.Results_B1")

boot.ci(logBoot_B1, type="bca",index = 1)

#Rsq.O - logistic analog to Rsq
RSQ.o_B1

#The Raw and Rescaled Weights
RW.Results_B1

#BCa Confidence Intervals around the raw weights
CI.Results_B1
colnames(CI.Results_B1) <- paste0(colnames(CI.Results_B1),"_CI")
```

Block 2
```{r}
set.seed(123456)

mydata_B2 <- thesis_NHRVS |>
  #Select all of the variables needed for the analysis
  dplyr::select(
    #IV
      Ex_rec,
    #Covariates
       Age,College, White_Race,
       Income_60k_plus, Combat_Veteran,
       TOTAL_TRAUMAS, BMI,
    #Physical Health Conditions
       Athsma, Chron_pain, Diabetes,
       Hrt_atk, Hrt_dis, High_chol,
       High_bld_press, Osteoporosis, Stroke, 
  ) |>
    # Convert all of the varaibles to numeric
    mutate(
      Ex_rec = as.numeric(Ex_rec),
      Age = as.numeric(Age),
      College = as.numeric(College),
      White_Race = as.numeric(White_Race),
      Income_60k_plus = as.numeric(Income_60k_plus),
      Combat_Veteran = as.numeric(Combat_Veteran),
      TOTAL_TRAUMAS = as.numeric(TOTAL_TRAUMAS),
      BMI = as.numeric(BMI),
      Athsma = as.numeric(Athsma),
      Chron_pain = as.numeric(Chron_pain), 
      Diabetes = as.numeric(Diabetes),
      Hrt_atk = as.numeric(Hrt_atk), 
      Hrt_dis = as.numeric(Hrt_dis), 
      High_chol = as.numeric(High_chol),
      High_bld_press = as.numeric(High_bld_press), 
      Osteoporosis = as.numeric(Osteoporosis), 
      Stroke = as.numeric(Stroke), 
    )

mydata <- na.omit(mydata)

mydata <- na.omit(mydata)

#2.4 run boot function
logBoot_B2<-boot(mydata_B2, # Data
              logBootstrap, # Statistic
              5000) # R / number of times

#2.5 confidence interval for bootstraps
logci_B2<-boot.ci(logBoot_B2,conf=0.95, type="bca")

boot.ci(logBoot_B2, type="bca",index = 1)

#2.6 runboot function
numVar<-NCOL(mydata_B2)

CI.Result_B2s<- tidy(logBoot_B2,conf.int=TRUE,conf.method="perc") 
CI.Results_B2
write_csv(CI.Results_B2, "~/Downloads/CI.Results_B2")

boot.ci(logBoot_B2, type="bca",index = 1)

#Rsq.O - logistic analog to Rsq
RSQ.o_B2

#The Raw and Rescaled Weights
RW.Results_B2

#BCa Confidence Intervals around the raw weights
CI.Results_B2
colnames(CI.Results_B2) <- paste0(colnames(CI.Results_B2),"_CI")

```


```{r, results='hide'}

mydata_B3 <- thesis_NHRVS |>
  #Select all of the variables needed for the analysis
  dplyr::select(
    #IV
      Ex_rec,
    #Covariates
       Age,College, White_Race,
       Income_60k_plus, Combat_Veteran,
       TOTAL_TRAUMAS, BMI,
    #Physical Health Conditions
       Athsma, Chron_pain, Diabetes,
       Hrt_atk, Hrt_dis, High_chol,
       High_bld_press, Osteoporosis, Stroke, 
    #Mental Health conditions
       AUD_Current, DUD_Current, MDD_Current, 
       PTSD_Current, GAD_Current    
  ) |>
    # Convert all of the varaibles to numeric
    mutate(
      Ex_rec = as.numeric(Ex_rec),
      Age = as.numeric(Age),
      College = as.numeric(College),
      White_Race = as.numeric(White_Race),
      Income_60k_plus = as.numeric(Income_60k_plus),
      Combat_Veteran = as.numeric(Combat_Veteran),
      TOTAL_TRAUMAS = as.numeric(TOTAL_TRAUMAS),
      BMI = as.numeric(BMI),
      Athsma = as.numeric(Athsma),
      Chron_pain = as.numeric(Chron_pain), 
      Diabetes = as.numeric(Diabetes),
      Hrt_atk = as.numeric(Hrt_atk), 
      Hrt_dis = as.numeric(Hrt_dis), 
      High_chol = as.numeric(High_chol),
      High_bld_press = as.numeric(High_bld_press), 
      Osteoporosis = as.numeric(Osteoporosis), 
      Stroke = as.numeric(Stroke), 
      AUD_Current = as.numeric(AUD_Current), 
      DUD_Current = as.numeric(DUD_Current), 
      MDD_Current = as.numeric(MDD_Current),
      PTSD_Current = as.numeric(PTSD_Current), 
      GAD_Current = as.numeric(GAD_Current)  
    )

mydata_B3 <- na.omit(mydata_B3)

#2. Bootstraps
#Bootstrap Confidence interval around the individual relative weights
#Please be patient -- This can take a few minutes to run

#2.1 the function to be ran
# logBoot<-boot(mydata, # Data 
#               logBootstrap, # Statistic
#               10000) # R / number of times

#2.2 Boot calls the logBootstrap function, which just pulls out the raw.relWeight at a given index
# logBootstrap<-function(mydata, indices){
# mydata<-mydata[indices,]
# logWeights<-logRegress(mydata)
# return(logWeights$Raw.RelWeight)
# }

#2.3 Set seed
set.seed(123456)

#2.4 run boot function
logBoot_B3 <-boot(mydata_B3, # Data
              logBootstrap, # Statistic
              10000) # R / number of times

write_csv(logBoot_B3,"/Users/troyh/Downloads/logBoot_B3")

#2.5 confidence interval for bootstraps
logci_B3<-boot.ci(logBoot_B3,conf=0.95, type="bca")

boot.ci(logBoot_B3, type="bca",index = 1)

#2.6 runboot function
numVar<-NCOL(mydata_B3)

CI.Result_B3s<- tidy(logBoot_B3,conf.int=TRUE,conf.method="perc") 
CI.Results_B3
write_csv(CI.Results_B3, "/Users/troyh/Downloads/CI.Results_B3")

# runBoot(length(mydata[,2:numVar]))



boot.ci(logBoot_B3, type="bca",index = 1)
# # runBoot<-function(num){

#3 #Bootstrapped Confidence interval tests of Significance
#Please be patient -- This can take a few minutes to run
#3.1 
# randVar<-rnorm(length(mydata[,1]),0,1)
# randData<-cbind(mydata,randVar)
# randData <- na.omit(randData)
# logRBoot<-boot(mydata,logBootrand, 5000)
# logRci<-boot.ci(logRBoot,conf=0.95, type="bca")
# 
# rand_CI_B3<- tidy(logRBoot,conf.int=TRUE,conf.method="perc")
# write_csv(rand_CI,"~/Downloads/rand_CI")
# runRBoot(length(randData[,2:(numVar-1)]))
# CI.Significance<-CIresult
# rand_CI
# 
# #Rsq.O - logistic analog to Rsq
# RSQ.o_B3
# 
# #The Raw and Rescaled Weights
# RW.Results_B3
# 
# sum(RW.Results$Raw.RelWeight)
# 
# #BCa Confidence Intervals around the raw weights
# CI.Results_B3
# colnames(CI.Results_B3) <- paste0(colnames(CI.Results_B3),"_CI")
# 
# #BCa Confidence Interval Tests of significance
# rand_CI_B3
# colnames(rand_CI_B3) <- paste0(colnames(rand_CI_B3),"_CI_R")
# #If Zero is not included, Weight is Significant
```


```{r, results='hide'}
weights_CI <- CI.Results |>
  mutate(
  Weight = round(statistic_CI*100,2),
  CI = paste0("[",
              round(conf.low_CI*100,2), ", ", round(conf.high_CI*100,2), "]")
  )

wt_df <- left_join(RW.Results,weights_CI, by= join_by(Raw.RelWeight==statistic_CI))
wt_df <- wt_df |>
  mutate(
    raw_weights = round(Raw.RelWeight*100,2),
    scale_check = round((Raw.RelWeight/sum(Raw.RelWeight)*100),2),
    CI_Low_raw = Rescaled.RelWeight - (1.96*(std.error_CI*100)),
    CI_High_raw = Rescaled.RelWeight + (1.96*(std.error_CI*100)),
    CI_low_rescale = conf.low_CI/(RSQ.o),
    CI_high_rescale = conf.high_CI/(RSQ.o),
    CI_low_percent = round(CI_low_rescale*100,2),
    CI_high_percent = round(CI_high_rescale*100,2),
    CI_rescale =
      paste0("[",CI_low_percent, ", ", CI_high_percent, "]"),
    wt_text = paste0(Rescaled.RelWeight, " [",CI_low_percent, ", ", CI_high_percent, "]")
  )

wt_df <- left_join(wt_df,Full_OR_tab, by= join_by(Variables==variable))

wt_df
```

```{r}
R2_plot <- ggplot2::ggplot(wt_df, aes(x=reorder(Variables,Raw.percent),y=Raw.percent)) +
  # geom_hline(yintercept = 1,linetype="dashed",alpha = .25) +
  # geom_hline(yintercept = .5,linetype="dashed",alpha = .25) +
  geom_bar(stat = "identity", color = "Black") +
  ggtitle("Psuedo R^2 (%) of predictors on Physical Activity") +
  theme_classic() +
  xlab('Variable')+
  ylab('Psuedo R^2 (%) in physical activity')+
  ylim(0,3)+
  geom_text(aes(label = Raw.percent), vjust =.5, hjust = -.5, color = "black")+
  coord_flip() 

CI_R2 <-  
      wt_df |>
      ggplot() +
        geom_text(aes(x = 0, y = reorder(Variables,Raw.percent), label = CI), hjust = 0) +
        theme_void() 
        # coord_cartesian(ylim = c(1,length(FP_dep$Variable)))

library(patchwork)
layout <- c(
  patchwork::area(t = 0, l = 0, b = 30, r = 21),
  patchwork::area(t = 0, l = 16, b = 30, r = 30)
)

R2_plot + CI_R2 + plot_layout(design = layout)
```


```{r, results='hide'}
 # wt_df <- wt_df |>
 #  mutate(
 #    
 #    
 #    
 # 
 #    
 # 
 #  )
 # 
 # 

```


```{r, results='hide'}
wt_plot <- ggplot2::ggplot(wt_df, aes(x=reorder(Variables,Rescaled.RelWeight),y=Rescaled.RelWeight)) +
  # geom_hline(yintercept = 1,linetype="dashed",alpha = .25) +
  # geom_hline(yintercept = .5,linetype="dashed",alpha = .25) +
  geom_bar(stat = "identity", color = "Black") +
  #ggtitle("Relative weight of predictors on Physical Activity") +
  labs(
    title = "Relative weight of predictors on Physical Activity",
    subtitle = "With 5000 bootstraped confidence intervals",
  ) +
  theme_classic() +
  xlab('Variable')+
  ylab('% weight (i.e., relative importance) of variance (Pseudo R^2) in physical activity')+
  ylim(0,45)+
  geom_text(aes(label = wt_text), vjust =.5, hjust = -.1, color = "black")+
  coord_flip() 




wt_df %>%
  ggplot(aes(y = reorder(Variables, Rescaled.RelWeight))) +
  geom_linerange(aes(xmin=CI_low_percent, xmax=CI_high_percent),size = 1.25, show.legend = FALSE) +
  #geom_errorbar(aes(xmin=CI_low_percent, xmax=CI_high_percent),width =.5, show.legend = FALSE) +
    geom_point(aes(x=Rescaled.RelWeight), shape = 18, size=5,show.legend = FALSE, color="red") +
  theme_classic() 
```


```{r, results='hide'}
Wald_plot  <- wt_df |>
      ggplot() +
        geom_text(aes(x = 0, y = reorder(Variables,Raw.percent), label = Wald), hjust = 0) +
        theme_void() 
        # coord_cartesian(ylim = c(1,length(FP_dep$Variable)))
      
library(patchwork)
layout <- c(
  patchwork::area(t = 0, l = 0, b = 30, r = 20),
  patchwork::area(t = 0, l = 16, b = 30, r = 30)
)

wt_plot + Wald_plot + plot_layout(design = layout)

```



using varImp from {caret} we can examine the relative importance of each variable
### Binary outcome
```{r}
library(caret)
#https://topepo.github.io/caret/variable-importance.html

V <- varImp(MHC_Reg, Scale=TRUE)

V <- V |>
  mutate(
    wt_scaled = round((Overall/sum(Overall))*100,2),
  variable = 
    c("Age", "College", "White_Race", "Income_60k_plus", "Combat_Veteran", 
      "TOTAL_TRAUMAS", "BMI", "Athsma", "Chron_pain", "Diabetes", "Hrt_atk", 
      "Hrt_dis",
      "High_chol", "High_bld_press", "Osteoporosis", "Stroke", "AUD_Current", 
      "DUD_Current", "MDD_Current", "PTSD_Current","GAD_Current")
  )

V <- left_join(V,Full_OR_tab, by= join_by(variable==variable))


# For classification, ROC curve analysis is conducted on each predictor. For two class problems, a series of cutoffs is applied to the predictor data to predict the class. The sensitivity and specificity are computed for each cutoff and the ROC curve is computed. The trapezoidal rule is used to compute the area under the ROC curve. This area is used as the measure of variable importance

L <- ggplot2::ggplot(V, aes(x=reorder(variable,wt_scaled), y=wt_scaled)) +
geom_point( color="blue", size=4, alpha=0.6)+
geom_segment( aes(x=variable, xend=variable, y=0, yend=wt_scaled), 
color='skyblue') +
xlab('Variable')+
ylab('Overall Importance (%) explained')+
theme_classic() +
coord_flip() 

Wald_plot  <- wt_df |>
      ggplot() +
        geom_text(aes(x = 0, y = reorder(Variables,Raw.percent), label = Wald), hjust = 0) +
        theme_void() 
        # coord_cartesian(ylim = c(1,length(FP_dep$Variable)))
      
library(patchwork)
layout <- c(
  patchwork::area(t = 0, l = 0, b = 30, r = 21),
  patchwork::area(t = 0, l = 16, b = 30, r = 30)
)

L + Wald_plot + plot_layout(design = layout)
```

### relative weight analysis
```{r}
devtools::install_github("martinctc/rwa")
#https://langtest.jp/shiny/rwa/
library(rwa)

RWA <- mydata_B3 %>%
  rwa(outcome = "Ex_rec",
      predictors = 
        c("Age", "College", "White_Race", "Income_60k_plus", "Combat_Veteran", 
      "TOTAL_TRAUMAS", "BMI", "Athsma", "Chron_pain", "Diabetes", "Hrt_atk", 
      "Hrt_dis",
      "High_chol", "High_bld_press", "Osteoporosis", "Stroke", "AUD_Current", 
      "DUD_Current", "MDD_Current", "PTSD_Current","GAD_Current"),
      applysigns = TRUE,
      plot = TRUE)

RWA$result

RWA_plot <- ggplot2::ggplot(RWA$result, aes(x=reorder(Variables,Rescaled.RelWeight), y=Rescaled.RelWeight)) +
geom_point( color="blue", size=4, alpha=0.6)+
geom_segment( aes(x=Variables, xend=Variables, y=0, yend=Rescaled.RelWeight), 
color='skyblue') +
xlab('Variable')+
ylab('Overall Importance (%) explained')+
theme_classic() +
coord_flip() 
```

RElative importance analysis
```{r}
library(relaimpo)


 
fit1 <- glm(MET_min~
             #Covariates
             Age + College + White_Race  +
             Income_60k_plus + Combat_Veteran + 
             TOTAL_TRAUMAS + BMI + 
             #Physical Health Conditions
             Athsma + Chron_pain + Diabetes+ Hrt_atk +
             Hrt_dis + High_chol + High_bld_press + Osteoporosis + Stroke +
             #Mental Health conditions
             AUD_Current + DUD_Current + MDD_Current + PTSD_Current + GAD_Current,
             # Data
             data =thesis_NHRVS,
             # Specify weights
             weights = weight)

relimp <- calc.relimp(fit1, type = "lmg", importance = TRUE)
calc.relimp
?calc.relimp()

# View the structure of the relimp object
str(relimp)
 
# Plot the relative importance of predictors
plot(relimp)

#order of which variables are important


impo_values<- unlist(relimp@lmg)
attri <- attributes(impo_values)
impo_order<- unlist(relimp@lmg.rank)

impo_df <- data.frame(
  cbind(
    vars = attri$names,
    round(impo_values*100,2),
    impo_order
  )
)
colnames(impo_df) <- c("vars","R2","Order")

impo_df$R2 <- as.numeric(impo_df$R2)
impo_df$Order <- as.numeric(impo_df$Order)

# ####### Bootstraped relimp
# 
# boot_rel <- boot.relimp(fit, type = "lmg", 
#                         nboot = 10)
#  
# boot_eval <- booteval.relimp(boot_rel)
# plot(boot_eval)
# 
# 
# 

ggplot2::ggplot(impo_df, aes(x=reorder(vars,-Order),y=R2),
                ) +
  geom_hline(yintercept = 1,linetype="dashed",alpha = .25) +
  geom_hline(yintercept = .5,linetype="dashed",alpha = .25) +
  geom_bar(stat = "identity", color = "Black") +
  ggtitle("% Varaince (i.e., R^2) explaiend by predictors of Physical Activity") +
  theme_classic() +
  xlab('Variable')+
  ylab('% of Response Variance')+
  ylim(0,1.5)+
  geom_text(aes(label = R2), vjust =.5, hjust = -.5, color = "black")+
  coord_flip() 
              
ggplot2::ggplot(V, aes(x=reorder(rownames(V),Overall), y=Overall)) +
geom_point( color="blue", size=4, alpha=0.6)+
geom_segment( aes(x=rownames(V), xend=rownames(V), y=0, yend=Overall), 
color='skyblue') +
xlab('Variable')+
ylab('Overall Importance')+
theme_light() +
coord_flip() 
```

```{r}
install.packages("bruceR")
library(bruceR)

mod_NHRVS <- thesis_NHRVS |>
  mutate(
    GAD_Current = recode(GAD_Current,
      "0" = "1",
      "1" = "2"
    ),
    Diabetes = recode(Diabetes,
      "0" = "1",
      "1" = "2"
    )
  )

str(mod_NHRVS$Diabetes)

thesis_NHRVS$High_bld_press

attri$names

###MCS
#insignificant moderation
PROCESS(thesis_NHRVS,
  x="High_bld_press", y="Ex_rec", mods = "MCS", covs = c("Age", "College", "White_Race",
  "Income_60k_plus", "Combat_Veteran", "TOTAL_TRAUMAS", "BMI") 
)

#nonsignficiant
PROCESS(thesis_NHRVS,
  x="Diabetes", y="Ex_rec", mods = "MCS", covs = c("Age", "College", "White_Race",
  "Income_60k_plus", "Combat_Veteran", "TOTAL_TRAUMAS", "BMI") 
)

#Significant
PROCESS(thesis_NHRVS,
  x="High_chol", y="Ex_rec", mods = "MCS", covs = c("Age", "College", "White_Race",
  "Income_60k_plus", "Combat_Veteran", "TOTAL_TRAUMAS", "BMI") 
)

#Significant
PROCESS(thesis_NHRVS,
  x="GAD_Current", y="Ex_rec", mods = "PCS", covs = c("Age", "College", "White_Race",
  "Income_60k_plus", "Combat_Veteran", "TOTAL_TRAUMAS", "BMI") 
)

#nonsignficiant
PROCESS(thesis_NHRVS,
  x="Diabetes", y="Ex_rec", mods = "MCS", covs = c("Age", "College", "White_Race",
  "Income_60k_plus", "Combat_Veteran", "TOTAL_TRAUMAS", "BMI")  
)
```

## Interactions of health conditions on physical activity recomendations
```{r}
# library(bruceR)
# # assign a vector of covariates to be used in analysis
# covs = c("Age", "College", "White_Race",
#   "Income_60k_plus", "Combat_Veteran", "TOTAL_TRAUMAS", "BMI")
# 
# ##### Diabetes
# PROCESS(thesis_NHRVS, # Data
#   x="Diabetes",  # Health conditoin
#   mods = "GAD_Current",  # Moderator
#   y="Ex_rec", # outcome variable
#   covs = covs) # covariates
# 
# PROCESS(thesis_NHRVS,
#   x="Diabetes", mods = "MDD_Current",
#   y="Ex_rec",
#   covs = covs)
# 
# PROCESS(thesis_NHRVS,
#   x="Diabetes", mods = "DUD_Current",
#   y="Ex_rec",
#   covs = covs)
# 
# #### Asthma
# PROCESS(thesis_NHRVS,
#   x="Athsma", mods = "Total_HC",
#   y="Ex_rec",
#   covs = covs)
# 
# ### Osteoporosis
# 
# PROCESS(thesis_NHRVS,
#   x="Osteoporosis", mods = "Total_HC",
#   y="Ex_rec",
#   covs = covs)
# 
# ### HRT Attack
# 
# PROCESS(thesis_NHRVS,
#   x="Hrt_atk", mods = "Total_HC",
#   y="Ex_rec",
#   covs = covs)
# 
# ### High cholesterol
# 
# PROCESS(thesis_NHRVS,
#   x="High_chol", mods = "Total_HC",
#   y="Ex_rec",
#   covs = covs)
# 
# PROCESS(thesis_NHRVS,
#   x="GAD_Current" , # Health condition
#   mods = "Total_HC", # moderator
#   y="Ex_rec", # outcome variable
#   covs = covs)
# 
# PROCESS(thesis_NHRVS,
#   x="MDD_Current", mods = "Total_HC",
#   y="Ex_rec",
#   covs = covs)
# 
# PROCESS(thesis_NHRVS,
#   x="Stroke", mods = "Total_HC",
#   y="Ex_rec",
#   covs = covs)
```

https://www.appsilon.com/post/r-logistic-regression
ROC. vs AUC
```{r}
Reg_df <- thesis_NHRVS |>
  dplyr::select(
    Ex_rec,
             #Covariates
             Age , College , White_Race  ,
             Income_60k_plus , Combat_Veteran , 
             TOTAL_TRAUMAS , BMI ,
             #Physical Health Conditions
             Athsma , Chron_pain , Diabetes, Hrt_atk , 
             Hrt_dis , High_chol , High_bld_press , Osteoporosis , Stroke ,
             #Mental Health conditions
             AUD_Current , DUD_Current , MDD_Current , PTSD_Current , GAD_Current,
             # Data
             weight)
Reg_df <-na.omit(Reg_df)

fit1<-glm(Ex_rec~
             #Covariates
             Age + College + White_Race  +
             Income_60k_plus + Combat_Veteran + 
             TOTAL_TRAUMAS + BMI +
             #Physical Health Conditions
             Athsma + Chron_pain + Diabetes+ Hrt_atk + 
             Hrt_dis + High_chol + High_bld_press + Osteoporosis + Stroke +
             #Mental Health conditions
             AUD_Current + DUD_Current + MDD_Current + PTSD_Current + GAD_Current,
             # Data
             data =Reg_df,
             # Specify type of regression
             family="binomial",weights = weight)

length(probabilities)
# just number of conditions
probabilities <-  predict(fit1, NewData=Reg_df ,type = "response")
predicted.classes <- ifelse(probabilities > 0.5, 1,0)

#confusion matrix
table(HC_df$Ex_rec, predicted.classes)
#roc
roc1 <- roc(response = Reg_df$Ex_rec,
               predictor = probabilities)

ggroc(roc1, legacy.axes = TRUE) +
  labs(x = 'False-positive rate', y = 'True-positive rate',
       title = 'ROC curve\nEx_rec ~ # Health Conditions + Covariates') +
  annotate('text', x = .5, y = .5, label = paste0('AUC: ', round(auc(roc1), digits = 2)))
```


```{r}
#just number of conditions

HC_df <- thesis_NHRVS |>
  dplyr::select(
    #outcome
    Ex_rec,
    #covaraiates
    Age,College,White_Race,Income_60k_plus,Combat_Veteran,TOTAL_TRAUMAS,BMI,  
    #HC
    Total_HC,
    #weights
    weight
  ) 

HC_df <- na.omit(HC_df)
library(caret)


fit2 <- glm(Ex_rec~
             #Covariates
             Age + College + White_Race  +
             Income_60k_plus + Combat_Veteran + 
             TOTAL_TRAUMAS + BMI + 
             #number of health conditions
             Total_HC,
             # Data
             data =HC_df,
             # Specify weights
             family = "binomial", weights = weight)


#install.packages("pROC")
library(pROC)


# just number of conditions
probabilities <-  predict(fit2, NewData=HC_df ,type = "response")
predicted.classes <- ifelse(probabilities > 0.5, 1,0)

#confusion matrix
table(HC_df$Ex_rec, predicted.classes)
#roc
roc2 <- roc(response = HC_df$Ex_rec,
               predictor = probabilities)

ggroc(roc2, legacy.axes = TRUE, col = "red") +
  labs(x = 'False-positive rate', y = 'True-positive rate',
       title = 'ROC curve\nEx_rec ~ # Health Conditions + Covariates') +
  annotate('text', x = .5, y = .5, label = paste0('AUC: ', round(auc(roc2), digits = 2)))


both_df <- thesis_NHRVS |>
  dplyr::select(
    Ex_rec,
             #Covariates
             Age , College , White_Race  ,
             Income_60k_plus , Combat_Veteran , 
             TOTAL_TRAUMAS , BMI ,
             #Physical Health Conditions
             Athsma , Chron_pain , Diabetes, Hrt_atk , 
             Hrt_dis , High_chol , High_bld_press , Osteoporosis , Stroke ,
             #Mental Health conditions
             AUD_Current , DUD_Current , MDD_Current , PTSD_Current , GAD_Current,
             Total_HC,
             # Data
             weight)
both_df <-na.omit(both_df)

fit3<-glm(Ex_rec~
             #Covariates
             Age + College + White_Race  +
             Income_60k_plus + Combat_Veteran + 
             TOTAL_TRAUMAS + BMI +
             #Physical Health Conditions
             Athsma + Chron_pain + Diabetes+ Hrt_atk + 
             Hrt_dis + High_chol + High_bld_press + Osteoporosis + Stroke +
             #Mental Health conditions
             AUD_Current + DUD_Current + MDD_Current + PTSD_Current + GAD_Current +
             Total_HC,
             # Data
             data =both_df,
             # Specify type of regression
             family="binomial",weights = weight)


# just number of conditions
probabilities3 <-  predict(fit3, NewData=Both_df ,type = "response")
predicted.classes3 <- ifelse(probabilities3 > 0.5, 1,0)

#confusion matrix
table(HC_df$Ex_rec, predicted.classes3)
#roc
roc3 <- roc(response = both_df$Ex_rec,
               predictor = probabilities3)

ggroc(roc3, legacy.axes = TRUE) +
  labs(x = 'False-positive rate', y = 'True-positive rate',
       title = 'ROC curve\nEx_rec ~ # Health Conditions + Conditions +  Covariates') +
  annotate('text', x = .5, y = .5, label = paste0('AUC: ', round(auc(roc3), digits = 2)))
```

predictive probabilities 
```{r}

HC_df <- thesis_NHRVS |>
  dplyr::select(
    #outcome
    Ex_rec,
    #covaraiates
    Age,College,White_Race,Income_60k_plus,Combat_Veteran,TOTAL_TRAUMAS,BMI,  
    #HC
    Total_HC,
    #weights
    weight)
  # ) |>
  # mutate(
  #   Ex_rec = as.factor(ifelse(Ex_rec == "Insufficient", 0,1))
  # )
HC_df <- na.omit(HC_df)
library(caret)

fit2 <- glm(relevel(Ex_rec,ref = "Sufficient")~
             #Covariates
             Age + College + White_Race  +
             Income_60k_plus + Combat_Veteran + 
             TOTAL_TRAUMAS + BMI + 
             #number of health conditions
             Total_HC,
             # Data
             data =HC_df,
             # Specify weights
             family = "binomial") #weights = weight)

OR <- round(exp(cbind(coef(fit2), confint(fit2))),2)

OR_fig <-paste0(OR[8,1], " [",OR[8,2], ",",OR[8,2], "]")

HC_df2$prob <- predict(fit2, NewData=HC_df ,type = "response")
HC_df2<- cbind(HC_df, predict(fit2, newdata = HC_df, type = "response",
    se = TRUE))

HC_df2 <- HC_df2 |>
  mutate(
    LL = fit - (1.96 * (se.fit),
    UL = fit + (1.96 * se.fit)
  )

# just number of conditions
ggplot(HC_df2, aes(x = Total_HC, y = fit)) + 
  #geom_ribbon(aes(ymin = LL,
    # ymax = UL), alpha = 0.2) + 
  geom_smooth(size = 1) +
  labs(x = '# of co-occuring health conditions', y = 'Predictive probability for insuficient activity',
       title = 'Predictive Probabilities\nExercise guidelines ~ # Health Conditions +  Covariates') +
  #annotate('text', x = 10, y = .6, label = paste0('OR: ', OR_fig)) +
  theme_classic()




```



```{r}
# Read in simulated data
sim_dat <- read.csv('http://static.lib.virginia.edu/statlab/materials/data/roc_sim_dat.csv', header = T)

# See a few rows
sim_dat[c(1, 25, 75, 100), ]

sim_dat

# Use pROC calculate TPR/FPR across a range of classification thresholds
sim_roc <- roc(response = sim_dat$actual_outcome,
               predictor = sim_dat$predicted_prob_of_Yes,
               levels = c('No', 'Yes'))
# response: vector of actual outcomes
# predictor: vector of probabilities, one for each observation
# levels: response values to be taken as "No"/0/"Failure"/etc. and "Yes"/1/"Success"/etc., respectively

# Plot ROC curve
# - pROC::ggroc() prints the ROC curve using ggplot2; you can print the curve using base R graphics with pROC::plot.roc()
# - legacy.axes = TRUE ensures that the x-axis is displayed as FPR from 0 to 1 as opposed to
#     specificity (1-FPR) from 1 to 0
ggroc(sim_roc, legacy.axes = TRUE) +
  labs(x = 'False-positive rate', y = 'True-positive rate', title = 'Simulated ROC curve')








roc(train.data$Ex_rec,
             predicted.classes)

\




summary(test.data$Ex_rec)
```



### Export Tables to CSV
```{r}
write_csv(Ins_Mod, "~/Desktop/Coding/data/Ins_Mod.csv")
write_csv(Ins_Act, "~/Desktop/Coding/data/Ins_Act.csv")
write_csv(Act_Mod, "~/Desktop/Coding/data/Act_Mod.csv")
```


# Create Tables for Multinomial Logistic Regression Output 

We have everything we need for our final table output!
```{r,message=FALSE}
#1. Import tables
   r2_change <- read_csv("~/Desktop/Coding/data/R2change.csv")
   cov.SF8_OR_tab <- read.csv("~/Desktop/Coding/data/SF8.cov_OR_tab.csv")
   Ins_Mod <- read_csv("~/Desktop/Coding/data/Ins_Mod.csv")
   Ins_Act <- read_csv("~/Desktop/Coding/data/Ins_Act.csv")
   Act_Mod <- read_csv( "~/Desktop/Coding/data/Act_Mod.csv")
```


```{r}
#2. Create dataframes to be merged.
    OR_Table = data.frame(
      Ins_Act$variable, Ins_Act$ci, Ins_Mod$ci, Act_Mod$ci,Act_Mod$r2_change
      )
    colnames(OR_Table) <- c("Variable","IvA_ODDS",
                          "IvM_ODDS", "AvM_ODDS",
                          "R2_Change")
    
#3. Create a block 3 row
  Block_3 = cbind(
    Variable = "Block 3: Health Conditions R^2 range = 0.032 - 0.052",
    IvA_ODDS = NA,
    IvM_ODDS = NA,
    AvM_ODDS = NA,
    R2_Change = NA
  )

#4. pull out values from covariates table
  Cov_table = data.frame(
    Full_OR_tab$variable,
    Full_OR_tab$IvA_ODDS, 
    Full_OR_tab$IvM_ODDS,
    Full_OR_tab$AvM_ODDS
  )
  Cov_table$R2_Change = NA
  colnames(Cov_table) <- c("Variable","IvA_ODDS",
                          "IvM_ODDS", "AvM_ODDS",
                          "R2_Change")

#5. Merge all the data frames
  OR_Table <- rbind(Cov_table,Block_3,OR_Table)

#6. update R2 change df and add it to OR tab
  r2_change = rbind(r2_change[1:6,],NA,r2_change[7:33,])
  OR_Table <- cbind(OR_Table[,1:4],r2_change)
  
#6. Rename columns for table 
  colnames(OR_Table) <- c("Variable","Insufficient vs Sufficient ORs",
                          "Insufficient vs Moderate ORs", "Active vs Moderate ORs", "R^2 Change")
  
  
#7. View Table
    knitr::kable(OR_Table) %>%
          kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

#8 Export Table
    write_csv(OR_Table,"~/Desktop/Coding/data/Thesis_OR_Table.csv")

```

```{r}

```


Multicolinearity Analysis
```{r}
library(tidyverse)
library(dplyr)
library(ggplot)
library(ggcorrplot)

thesis_NHRVS$Hrt_dis
```


```{r}
#physical health conditions
corr1 <- thesis_NHRVS |>
  dplyr::select(Ex_3cat,Any_Disability, Age, College , Income_60k_plus, YN_work , BMI , MCS
    )

model.matrix(~0+., data=corr1) %>% 
  cor(use="pairwise.complete.obs") %>% 
  ggcorrplot(show.diag=FALSE, type="lower", lab=TRUE, lab_size=2)

# mental health conditions
corr2 <- thesis_NHRVS |>
  dplyr::select(Ex_3cat,LT_MDD, Age, College , Income_60k_plus, YN_work , BMI , PCS
    )

model.matrix(~0+., data=corr2) %>% 
  cor(use="pairwise.complete.obs") %>% 
  ggcorrplot(show.diag=FALSE, type="lower", lab=TRUE, lab_size=2)

```

