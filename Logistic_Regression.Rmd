---
title: "Logistic Multinomial Regresion"
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: false
    toc_depth: 1
    #code_folding: hide
---

The following code will show you how I created functions to run my multinomial regressions. This page includes:

1. Create function to run univariate multinomial regressions.
2. Run block 1 of the step wise multivariate multinomial regression.
3. Run block 2 of the step wise multivariate multinomial regression. 
4. Create function for block 3 of step wise multivariate multinomial regression.
5. Obtain R^2 values for each varaible in regressio model, and R^2 change between blocks of the stepwise regression
6. Run function for block 3 of the step wise multivariate multinomial regression.
7. Create table of output from stepwise regression model. 

--- 
```{r, include=FALSE}
# Setup
# libraries

if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, dplyr, haven,kableExtra,MASS,nnet,performance,fuzzySim,
               boot, broom,aod,caret)

  #data stuff
library(tidyverse)
library(dplyr)
  #CSV/CAV files
library(haven)
  #EDA stuff
library(kableExtra)
library(MASS)
library(nnet)
library(performance)
library(fuzzySim) #FDR corrections
library(broom) #for tidy models
  library(aod) # Wald test
library(boot) #bootstrapping
#library(caret) #weight analysis???
options(knitr.table.format = "html")

## Prepare Data For Analysis

#### Import & Select data
path <- #"/Users/troyh/OneDrive/Documents/R/Data/NHRVS_2019_2020_FINAL_weighted.sav"
ifelse(Sys.info()[[1]] == "Windows","/Users/troyh/OneDrive/Documents/R/Data/NHRVS_2019_2020_FINAL_weighted.sav",
       ifelse(Sys.info()[[1]] == "Darwin", "~/Desktop/Adams_lab/SPSS_stuff/NHRVS_2019_2020_FINAL_weighted.sav", "¿¿Donde Estoy??"
       ))

### Import dataset
NHRVS_2019 <- read_sav(path)

str(NHRVS_2019$godin_total_ac)
view(NHRVS_2019)

### Select and rename Variables
thesis_NHRVS <- dplyr::select(NHRVS_2019,
    #Background Variables __________
      caseid,weight,Age,Male_Gender,White_Race,SomeCollege_or_Higher,
      Married_Partnered,Income_60k_plus,YN_work,
      PCS_FINAL,MCS_FINAL,Weight_kg,BMI,
    #Military variables__________
      Combat_Veteran,Years_in_Military,Branch_5cat,Enlistment_status_3cat,
      MilitaryRank_3cat,
    #Mental Health Variables___________
      TOTAL_TRAUMAS,PM_PCL_31,MDD_POSITIVE_CURRENT,GAD_POSITIVE_CURRENT,SI_CURRENT,
      AUD_CURRENT,DUD_CURRENT,Concussion_PosScreen,tot_MHC,Any_MHC,
    #Physical health Variables_________
      ANY_ADL_DISABILITY,ANY_IADL_DISABILITY,Any_Disability,tot_phc,Any_PHC,Q22A_1,Q22A_2,
      Q22A_3,Q22A_4,Q22A_5,Q22A_6,Q22A_7,Q22A_8,Q22A_9,Q22A_10,Q22A_11,Q22B_1,
      Q22B_2,Q22B_3,Q22B_4,Q22B_5,
    #Exercise variables ___________
      godin_mild_winsor,godin_Mod_winsor,godin_Stren_winsor,HCS,HCS_Cats,
      godin_total_ac,god3cat,god2cat,GODIN_outliers,
    #Education variables __________\
    ppeduc, ppeducat,
    #Continuous MH
    GAD_SYMPTOMS_CURRENT, MDD_SYMPTOMS_CURRENT, SUM_PM_PCL, AUDIT_SUM
    )

#Rename variabes
thesis_NHRVS <- rename(thesis_NHRVS,
      MET_total = godin_total_ac,
      God_mild = godin_mild_winsor,
      God_mod = godin_Mod_winsor,
      God_stren = godin_Stren_winsor,
      College = SomeCollege_or_Higher,
      MCS = MCS_FINAL,
      PCS = PCS_FINAL,
      Arthritis = Q22A_1,
      Athsma =  Q22A_2,
      Cancer = Q22A_3,
      Chron_pain = Q22A_4,
      Liv_dis = Q22A_5,
      Diabetes = Q22A_6,
      Hrt_dis = Q22A_7,
      Hrt_atk = Q22A_8,
      High_chol = Q22A_9,
      High_bld_press = Q22A_10,
      Kid_dis = Q22A_11,
      Migrane = Q22B_1,
      MS = Q22B_2,
      Osteoporosis = Q22B_3,
      Rhum_arth = Q22B_4,
      Stroke = Q22B_5,
      PTSD_Current = PM_PCL_31,
      MDD_Current = MDD_POSITIVE_CURRENT,
      GAD_Current = GAD_POSITIVE_CURRENT,
      SI_Current = SI_CURRENT,
      AUD_Current = AUD_CURRENT,
      DUD_Current = DUD_CURRENT,
      Concussion_current = Concussion_PosScreen,
      edu = ppeduc,
      Education_Cat = ppeducat
)
# We need exercsie variables that are in MET minutes, not just HCS.
# We also need to create demographic and health variables

thesis_NHRVS<- thesis_NHRVS %>%
  # First Create all of the variables
  mutate(thesis_NHRVS,
    # Exercise variables
         Ex_time = (God_mild + God_mod + God_stren)*15,
            # Tells us how long people exercised for.
         MET_min = MET_total* 15,
         MET_min_W = ifelse(MET_min > 2500, 2500, MET_min),
            # Total METs per week times the duration of exercise
         Ex_rec = as.factor(ifelse(MET_min >= 500, "Sufficient", "Inufficient")),
            # Meeting activity levels (i.e., sufficient vs insufficient)
         Ex_3cat = as.factor(ifelse(MET_min < 290, 1,
                              ifelse(MET_min < 500 & MET_min >= 290, 2,3))),
         Ex_4cats = as.factor(ifelse(MET_min < 290, "Sed",
                              ifelse(MET_min < 500 & MET_min >= 290, "Mod",
                              ifelse(MET_min < 1000 & MET_min >= 500, "Active",
                              ifelse(MET_min < 2000 & MET_min >= 1000, "Super", NA))))),
         Ex_3catW = as.factor(ifelse(MET_min_W < 290, 1,
                              ifelse(MET_min_W < 500 & MET_min_W >= 290, 2,3))),
         Ex_4catsW = as.factor(ifelse(MET_min_W < 290, "Sed",
                              ifelse(MET_min_W < 500 & MET_min_W >= 290, "Mod",
                              ifelse(MET_min_W < 1000 & MET_min_W >= 500, "Active",
                              ifelse(MET_min_W < 2500 & MET_min_W >= 1000, "Super", NA))))),
# 3 godin (HCS) categories converted to MET_min
    # Other Variables
         HCS_win = (God_mod*5) + (God_stren*9),
         HCS3cat = as.factor(ifelse(HCS_win < 14, "Insufficient",
                              ifelse(HCS_win < 24 & HCS_win >= 290, "Moderate", "Active"))),
         Yr5_Military = as.factor(ifelse(Years_in_Military >= 5, "5+", "<5")),
         Active_PA = as.factor(ifelse(Ex_3cat == 3,1,0)),
         Moderate_PA = as.factor(ifelse(Ex_3cat == 2,1,0)),
         Insuf_PA = as.factor(ifelse(Ex_3cat == 2,1,0)),
         Total_HC = Any_Disability + Arthritis + Cancer + Chron_pain + Liv_dis +
                    Diabetes + Hrt_dis + Hrt_atk + High_chol + High_bld_press +
                    Kid_dis + Migrane + MS + Osteoporosis + Rhum_arth + Stroke +
                    PTSD_Current + MDD_Current + GAD_Current + AUD_Current + DUD_Current,
         Total_PHC = Any_Disability + Arthritis + Cancer + Chron_pain + Liv_dis +
                    Diabetes + Hrt_dis + Hrt_atk + High_chol + High_bld_press +
                    Kid_dis + Migrane + MS + Osteoporosis + Rhum_arth + Stroke,
         Total_MHC = PTSD_Current + MDD_Current + GAD_Current + AUD_Current + DUD_Current,
         No_Condition = ifelse(Any_MHC == 1 | Any_PHC ==1, 0,1)

    ) %>%
mutate(thesis_NHRVS,
      #Physical health variables
           Any_Disability = as.factor(Any_Disability),
           Arthritis = as.factor(Arthritis),
           Athsma = as.factor(Athsma),
           Cancer = as.factor(Cancer),
           Chron_pain = as.factor(Chron_pain),
           Liv_dis = as.factor(Liv_dis),
           Diabetes = as.factor(Diabetes),
           Hrt_dis = as.factor(Hrt_dis),
           Hrt_atk = as.factor(Hrt_atk),
           High_chol = as.factor(High_chol),
           High_bld_press = as.factor(High_bld_press),
           Kid_dis = as.factor(Kid_dis),
           Migrane = as.factor(Migrane),
           MS = as.factor(MS),
           Osteoporosis = as.factor(Osteoporosis),
           Rhum_arth = as.factor(Rhum_arth),
           Stroke = as.factor(Stroke),
           Ex_3cat = as.factor(Ex_3cat),
           Male_Gender = as.factor(Male_Gender),
           Married_Partnered = as.factor(Married_Partnered),
           White_Race = as.factor(White_Race),
           College = as.factor(College),
           Income_60k_plus = as.factor(Income_60k_plus),
           YN_work = as.factor(YN_work),
           Combat_Veteran = as.factor(Combat_Veteran),
           Any_MHC = as.factor(Any_MHC),
           Any_PHC = as.factor(Any_PHC),
           god2cat = as.factor(god2cat),
      #Mental health variables
          PTSD_Current = as.factor(PTSD_Current),
          MDD_Current = as.factor(MDD_Current),
          GAD_Current = as.factor(GAD_Current),
          # SI_Current = SI_CURRENT,
          AUD_Current = as.factor(AUD_Current),
          DUD_Current = as.factor(DUD_Current),
    #Education variables
      Education_Cat = as.factor(Education_Cat)
    )
thesis_NHRVS <- mutate(thesis_NHRVS,
        Ex_3cat = recode(Ex_3cat,
                         "1" = "Insufficient",
                         "2" = "Moderate",
                         "3" = "Active"),
        Married_Partnered = recode(Married_Partnered,
                         "0" = "Married_Partnered",
                         "1" = "Single"),
        Male_Gender = as.factor(Male_Gender),
        Male_Gender = recode(Male_Gender,
                         "0" = "Female",
                         "1" = "Male"),
        White_Race = recode(White_Race,
                         "0" = "Not_White",
                         "1" = "White"),
        College = recode(College,
                         "0" = "No_Colege",
                         "1" = "Some_Colege"),
        Income_60k_plus = recode(Income_60k_plus,
                         "0" = "Under_60k",
                         "1" = "OVer_60k"),
        YN_work = recode(YN_work,
                         "1" = "No_Work",
                         "2" = "Working"),
        Combat_Veteran = as.factor(Combat_Veteran),
        Combat_Veteran = recode(Combat_Veteran,
                         "0" = "No_Combat",
                         "1" = "Combat"),
        Any_MHC = recode(Any_MHC,
                         "0" = "No_con",
                         "1" = "MHC"),
        Any_PHC = recode(Any_PHC,
                         "0" = "No_con",
                         "1" = "PHC"),
        Education = ifelse(edu <= 9, "HS Education or Less",
                    ifelse(edu == 10 | edu == 11, "Some College",
                    ifelse(edu == 12, "Bacholars Degree", "Advanced Degree"
                    ))),
        Education = as.factor(Education),
        Educatoin_Cat  = recode(Education_Cat,
                         "1" = "< HS",
                         "2" = "HS",
                         "3" = "Some College",
                         "4" = "Bachelor or Higher")
        )

#Filter out NA values
thesis_NHRVS <- thesis_NHRVS %>%
  filter(!is.na(Ex_rec)) %>%
  filter(!is.na(Ex_3cat)) %>%
  filter(!is.na(MCS)) %>%
  filter(!is.na(PCS)) %>%
  filter(!is.na(BMI)) %>%
  filter(!is.na(Any_Disability)) %>%
  filter(!is.na(Arthritis)) %>%
  filter(!is.na(Cancer)) %>%
  filter(!is.na(Chron_pain)) %>%
  filter(!is.na(Liv_dis)) %>%
  filter(!is.na(Diabetes)) %>%
  filter(!is.na(Hrt_dis)) %>%
  filter(!is.na(Hrt_atk)) %>%
  filter(!is.na(High_chol)) %>%
  filter(!is.na(High_bld_press)) %>%
  filter(!is.na(Kid_dis)) %>%
  filter(!is.na(Migrane)) %>%
  filter(!is.na(MS)) %>%
  filter(!is.na(Osteoporosis)) %>%
  filter(!is.na(Rhum_arth)) %>%
  filter(!is.na(Stroke)) %>%
  filter(!is.na(MDD_Current)) %>%
  filter(!is.na(PTSD_Current)) %>%
  filter(!is.na(AUD_Current)) %>%
  filter(!is.na(DUD_Current)) %>%
  filter(!is.na(edu)) |>
  filter(!is.na(GAD_Current)) |>
  mutate(Obesity = ifelse(is.na(BMI), NA,
      ifelse(BMI >=30,1,0)),
      Obesity = as.factor(Obesity)
           )
  
#$View(thesis_NHRVS)


```




# Preliminary Regression: Univariate Regression function

The first step in my analysis was to run the multinomial regressions without covariates so I can see how the health conditions are associated with physical activity level independent of covariates. The following `UniThesis()` function does the following:

1. Runs the multinomial models using `multinom()`
2. Manually calculates the coefficients _B_, the odds ratios (OR) + 95% Confideince interval (95% CI), and _p_ values
3. Extracts respective values for each type of comparison (e.g., sufficiently active vs moderatly active)
4. Returns respective values as a row in a data frame which can be compiled into a larger data frame per comparison

# Step Wise Multivariate Logistic Multinomial Regression
That's a mouthful! For the following section we will be running code for the full regression model, The blocks of this regession are as follows:

1. Covariates: Sociodemograpahic, military, and health variables
2. Physical health conditions
3. Mental Health Conditions

## Regession Code {.tabset}

### Block 1: Covariates
This first block of the stepwise regression will do the same thing as we did for the univariate analysis, being that this was not replicated we did not make a function for it.

```{r,warning=FALSE,message=FALSE,results='hide'}
### Part 1 Create values for table
#1. Run the models
Cov_Reg<-glm(Ex_rec~ + Age + College + White_Race  + Income_60k_plus + Combat_Veteran + 
                           TOTAL_TRAUMAS, data= thesis_NHRVS,family="binomial") 
  

Cov_Reg_sum <- summary(Cov_Reg)
Cov_Reg_sum <- tidy(Cov_Reg) 

#2. Coefficients 
  coefs_Cov_Reg <- abs(coef(Cov_Reg))
  coefs_Cov_Reg 
#3. Odds ratio
  OR_Cov_Reg <- exp(coef(Cov_Reg))

#4. OR 95% CI
  CI_Cov_Reg <- data.frame(round(exp(confint(Cov_Reg)),2))

#5. P values 
  p_val1<- cbind(Cov_Reg_sum$term ,Cov_Reg_sum$p.value)
    adj.p <- FDR(pvalues = p_val1)
    ADJ.p.values <- data.frame(rbind(adj.p$exclude, adj.p$select))
    ADJ.p.values
    
#6. R^2 for model
  R2_Cov_Reg <- performance::r2(Cov_Reg)

#wald

  cov_wald<- wald.test(b = coef(Cov_Reg),Sigma = vcov(Cov_Reg),Terms= 2:7)
  cov_wald$result$chi2[1]
  wald <- wald.test(b = coef(Cov_Reg),Sigma = vcov(Cov_Reg),Terms=2)$result$chi2[1]
  for(i in 3:7){
      wald <- append(wald, wald.test(b = coef(Cov_Reg),Sigma = vcov(Cov_Reg),Terms=i)$result$chi2[1])
  }
  wald
#### Part 2. Make the table and export 

#1. Create data frame
cov_OR_df <-  data.frame(cbind(
  variable = Cov_Reg_sum$term[2:length(Cov_Reg_sum$term)],
  Beta = coefs_Cov_Reg[2:length(Cov_Reg_sum$term)],
  Wald = round(wald,2),
  OR = OR_Cov_Reg[2:length(OR_Cov_Reg)],
  CI = paste0("[",CI_Cov_Reg[2:length(OR_Cov_Reg),1], ",", CI_Cov_Reg[2:length(OR_Cov_Reg),2], "]"),
  p = p_val1[2:7,2]
))


cov_OR_df  <- left_join(cov_OR_df, ADJ.p.values,by = join_by(p == p.value))
cov_OR_tab <- data.frame(cbind(
  variable = cov_OR_df$variable,
  Beta = cov_OR_df$Beta,
  Wald = cov_OR_df$Wald,
  OR = cov_OR_df$OR,
  CI = cov_OR_df$CI,
  p = cov_OR_df$p.adjusted
))

cov_OR_tab$Beta = round(as.numeric(cov_OR_tab$Beta),2)
cov_OR_tab$Wald = round(as.numeric(cov_OR_tab$Wald),2)
cov_OR_tab$OR = round(as.numeric(cov_OR_tab$OR),2)
cov_OR_tab$p = ifelse(as.numeric(cov_OR_df$p) < 0.001, "< 0.001",
  round(as.numeric(cov_OR_df$p),3))

#2. create the row for the R2
  paste("Block 1 R^2 =", round((R2_Cov_Reg[[1]]*100),3),"%")
  variable = c(
    "Block 1 - Covariates",
    paste0("X^2=", round(cov_wald$result$chi2[1],2),",p<0.001"),
    paste0("R^2=", round((R2_Cov_Reg[[1]]),3))  
  )



  R2TAB<-data.frame(cbind(
                      variable,Beta=NA,Wald=NA, OR =NA, CI=NA, p=NA))

#3. Bind the stuff together
  cov_OR_tab <- rbind(R2TAB, cov_OR_tab)
cov_OR_tab
#4. Export
  # write_csv(cov_OR_tab,"~/Desktop/Coding/data/EX_C_cov_OR_tab.csv")
```
```{r}
  knitr::kable(cov_OR_tab) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

### Full Model Function

The final step in my analysis was to run the full multinomial model so I can see how the health conditions are associated with physical activity level after controling for covariates. The following `MultiThesis()` function does the following 
1. Runs the 2 different multinomial models using [multinom()](https://www.rdocumentation.org/packages/nnet/versions/7.3-18/topics/multinom)
    + Physical health condtions include the MCS
    + Mental health conditions include the PCS
2. Manually calculates the coefficients _B_, the odds ratios (OR) + 95% Confideince interval (95% CI), and _p_ values
3. Extracts respective values for each type of comparison (e.g., sufficiently active vs moderatly active)
4. Returns respective values as a row in a dataframe which can be compiled into a larger data fram per comparison


Make a function to run a chi2 and save the output for all physical health conditions
```{r}
Condition_eval<-function(condition,string){
  chi2 <- xtabs(~thesis_NHRVS$Ex_rec + condition)
  output <- data.frame(cbind(
    variable = string, 
    chi2 = summary(chi2)[[3]], 
    p = summary(chi2)[[6]]
  ))
  return(output)
}
```


Run the chi2 function to get an output of what variables we should include in our regression model
```{r,include=FASLSE}
#1. run model 1
Conditions_chi<-data.frame(Condition_eval(thesis_NHRVS$Arthritis,"Arthritis"))
#3. Asthma
Conditions_chi<-rbind(Conditions_chi,Condition_eval(thesis_NHRVS$Athsma,"Athsma"))
#4. Cancer
Conditions_chi<-rbind(Conditions_chi,Condition_eval(thesis_NHRVS$Cancer,"Cancer"))
#5. Chronic Pain
Conditions_chi<-rbind(Conditions_chi,Condition_eval(thesis_NHRVS$Chron_pain,"Chronic Pain"))
#6. Diabetes
Conditions_chi<-rbind(Conditions_chi,Condition_eval(thesis_NHRVS$Diabetes,"Diabetes"))
#7. Heart Attack
Conditions_chi<-rbind(Conditions_chi,Condition_eval(thesis_NHRVS$Hrt_atk,"Heart Attack"))
#8. Heart Disease
Conditions_chi<-rbind(Conditions_chi,Condition_eval(thesis_NHRVS$Hrt_dis,"Heart Disease"))
#9. High Cholesterol
Conditions_chi<-rbind(Conditions_chi,Condition_eval(thesis_NHRVS$High_chol,"High Cholesterol"))
#10. Hypertension
Conditions_chi<-rbind(Conditions_chi,Condition_eval(thesis_NHRVS$High_bld_press,"Hypertension"))
#11. Kidney Disease
Conditions_chi<-rbind(Conditions_chi,Condition_eval(thesis_NHRVS$Kid_dis,"Kidney Disease"))
#12. Liver Disease
Conditions_chi<-rbind(Conditions_chi,Condition_eval(thesis_NHRVS$Liv_dis,"Liver Disease"))
#13. Migrane
Conditions_chi<-rbind(Conditions_chi,Condition_eval(thesis_NHRVS$Migrane,"Migrane"))
#14. MS
Conditions_chi<-rbind(Conditions_chi,Condition_eval(thesis_NHRVS$MS,"MS"))
#15. Osteoporosis
Conditions_chi<-rbind(Conditions_chi,Condition_eval(thesis_NHRVS$Osteoporosis,"Osteoporosis"))
#15. Obesiety
Conditions_chi<-rbind(Conditions_chi,Condition_eval(thesis_NHRVS$Obesity,"Obesity"))
#16. Rheumatoid Arthritis
Conditions_chi<-rbind(Conditions_chi,Condition_eval(thesis_NHRVS$Rhum_arth,"RA"))
#17. Stroke
Conditions_chi<-rbind(Conditions_chi,Condition_eval(thesis_NHRVS$Stroke,"Stroke"))
# ### Mental Health Conditions
#18. Alcohol Use Disorder
Conditions_chi<-rbind(Conditions_chi,Condition_eval(thesis_NHRVS$AUD_Current,"AUD"))
#19. Drug Use Disorder
Conditions_chi<-rbind(Conditions_chi,Condition_eval(thesis_NHRVS$DUD_Current,"DUD"))
#20. Major Depressive Disorder
Conditions_chi<-rbind(Conditions_chi,Condition_eval(thesis_NHRVS$MDD_Current,"MDD"))
#22 Posttraumatic Stress Disorder
Conditions_chi<-rbind(Conditions_chi,Condition_eval(thesis_NHRVS$PTSD_Current,"PTSD"))
#23 Generalized Anxiety Disorder
Conditions_chi<-rbind(Conditions_chi,Condition_eval(thesis_NHRVS$GAD_Current,"GAD"))
```


Extracting values from chi square tables. 
```{r}
#table with and without health conditions
  xtable2  <- xtabs(~Athsma+Ex_rec,data = thesis_NHRVS)
  xtable2  <- rbind(xtable2,xtabs(~Arthritis+Ex_rec,data = thesis_NHRVS))
  xtable2  <- rbind(xtable2,xtabs(~Cancer+Ex_rec,data = thesis_NHRVS))
  xtable2  <- rbind(xtable2,xtabs(~Chron_pain+Ex_rec,data = thesis_NHRVS))
  xtable2  <- rbind(xtable2,xtabs(~Liv_dis+Ex_rec,data = thesis_NHRVS))
  xtable2  <- rbind(xtable2,xtabs(~Diabetes+Ex_rec,data = thesis_NHRVS))
  xtable2  <- rbind(xtable2,xtabs(~Hrt_dis+Ex_rec,data = thesis_NHRVS))
  xtable2  <- rbind(xtable2,xtabs(~Hrt_atk+Ex_rec,data = thesis_NHRVS))
  xtable2  <- rbind(xtable2,xtabs(~High_chol+Ex_rec,data = thesis_NHRVS))
  xtable2  <- rbind(xtable2,xtabs(~High_bld_press+Ex_rec,data = thesis_NHRVS))
  xtable2  <- rbind(xtable2,xtabs(~Kid_dis+Ex_rec,data = thesis_NHRVS))
  xtable2  <- rbind(xtable2,xtabs(~Migrane+Ex_rec,data = thesis_NHRVS))
  xtable2  <- rbind(xtable2,xtabs(~MS+Ex_rec,data = thesis_NHRVS))
  xtable2  <- rbind(xtable2,xtabs(~Osteoporosis+Ex_rec,data = thesis_NHRVS))
  xtable2  <- rbind(xtable2,xtabs(~Obesity+Ex_rec,data = thesis_NHRVS))
  xtable2  <- rbind(xtable2,xtabs(~Rhum_arth+Ex_rec,data = thesis_NHRVS))
  xtable2  <- rbind(xtable2,xtabs(~Stroke+Ex_rec,data = thesis_NHRVS))
  xtable2  <- rbind(xtable2,xtabs(~AUD_Current+Ex_rec,data = thesis_NHRVS))
  xtable2  <- rbind(xtable2,xtabs(~DUD_Current+Ex_rec,data = thesis_NHRVS))
  xtable2  <- rbind(xtable2,xtabs(~MDD_Current+Ex_rec,data = thesis_NHRVS))
  xtable2  <- rbind(xtable2,xtabs(~PTSD_Current+Ex_rec,data = thesis_NHRVS))
  xtable2  <- rbind(xtable2,xtabs(~GAD_Current+Ex_rec,data = thesis_NHRVS))
xtable2<-data.frame(xtable2)
#create a varaible for diagnosis
xtable2$condition<- NA
diagnose<- c("No Condition","Condition")
xtable2$condition = diagnose
xtable2

knitr::kable(xtable2[1:10,]) %>%
   kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

```{r,include=FALSE}
  var_names = c("Asthma",
                "Arthritis",
                "Cancer",
                "Chron pain",
                "Liver Disease",
                "Diabetes",
                "Heart Disease", 
                "Heart Attack", 
                "High Cholesterol", 
                "Hypertension", 
                "Kidney Disease", 
                "Migraine", 
                "MS", 
                "Osteoporosis", 
                "Obesity",
                "Rheumatoid Arthritis", 
                "Stroke",
                "AUD", 
                "DUD",
                "MDD", 
                "PTSD", 
                "GAD")

#2. Varaible names for table 
 var_names2 = c("Asthsma","Asthsma",
                "Arthritis", "Arthritis",
                "Cancer","Cancer",
                "Chron pain","Chron pain",
                "Liver Disease","Liver Disease",
                "Diabetes","Diabetes",
                "Heart Disease", "Heart Disease",
                "Heart Attack", "Heart Attack",
                "High Cholesterol", "High Cholesterol",
                "Hypertension", "Hypertension", 
                "Kidney Disease", "Kidney Disease",
                "Migraine",  "Migraine", 
                "MS", "MS", 
                "Osteoporosis", "Osteoporosis",
                "Obesity", "Obesity",
                "Rheumatoid Arthritis", "Rheumatoid Arthritis",
                "Stroke","Stroke",
                "AUD", "AUD",
                "DUD","DUD",
                "MDD",  "MDD", 
                "PTSD", "PTSD", 
                "GAD", "GAD")
 
 length(var_names2)*2
 
 xtable2$Inufficient

###############START HERE######################
#3. make long data frame (needed for plot)
      condition_df2          <- var_names2
      condition_df2 <- data.frame(condition_df2) 
      condition_df2 <- rbind(condition_df2,condition_df2)
      condition_df2[1:88,1]  <- var_names2              
      condition_df2[1:44,2]  <-  xtable2$Inufficient
      condition_df2[1:44,3]  =  "Insufficient"
      condition_df2[45:88,2] <- xtable2$Sufficient
      condition_df2[45:88,3] <- "Sufficient"
      condition_df2$Diagnosis = xtable2$condition
      names(condition_df2) <- c("Variable","Value","Ex_rec","Diagnosis")
      knitr::kable(condition_df2[1:10,]) %>%
         kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
      
```


Now that we have the data we can plot it! I use `ggplot()` to plot the figure. As this is a bar chart I use `geom_bar()` and use `position="stack"` to make the stacked bar chart. I used `fct_reorder()` to order the chart in order of the number of veterans reporting that condition. `facet_grid()` was used to seperate the the number of veterans with and without conditions into different figures. Lastly of note, I used `coord_flip()` to put both of the figures on the Y axis. 
```{r}

#left side

X2_L<- 
  subset(condition_df2,Diagnosis =="No Condition") |>
  ggplot( aes(fill=Ex_rec, y=Value, x= fct_reorder(Variable, -Value))) + 
  geom_bar(position="stack", stat="identity")+
  # facet_grid(~ Diagnosis)+ 
  ylab('Number of Veterans') +
  xlab('Health Condition')+
  labs(fill='Physical Activity') +
  theme_classic()+
  theme(legend.position="none")+
  coord_flip()+
    scale_fill_manual(values=c("#e36d36","#1cc75b"))+
  scale_y_reverse() +
  theme(axis.line.y = element_blank(),
        axis.ticks.y= element_blank(),
        axis.text.y= element_blank(),
        axis.title.y= element_blank())

#right side
X2_R<- 
  subset(condition_df2,Diagnosis =="Condition") |>
  ggplot( aes(fill=Ex_rec, y=Value, x= fct_reorder(Variable, Value))) + 
  geom_bar(position="stack", stat="identity")+
  # facet_grid(~ Diagnosis)+ 
  ylab('Number of Veterans') +
  xlab('Health Condition')+
  labs(fill='Physical Activity') +
  theme_classic()+
  theme(legend.position="None")+
  coord_flip(ylim = c(0,3500)) +
  scale_fill_manual(values=c("#e36d36","#1cc75b"))+
  theme(axis.line.y = element_blank(),
        axis.ticks.y= element_blank(),
        axis.text.y= element_blank(),
        axis.title.y= element_blank())

# get chi2 values for middle of plot 
Conditions_chi$chichi = round(as.numeric(Conditions_chi$chi2),2)
Conditions_chi$p = as.numeric(Conditions_chi$p)
Conditions_chi1 <- Conditions_chi |>
  mutate(
    label = 
      ifelse(p < 0.001, paste0(chichi,"***"),
        ifelse(p < 0.01, paste0(chichi,"**"),
          ifelse(p < 0.05, paste0(chichi,"*"), 
            chichi
                 ))))

mid_dp <- subset(condition_df2,Diagnosis =="Condition")
mid_dp$label = Conditions_chi1$label

# middle of plot
X2_M<- 
  mid_dp |>
  ggplot(aes( y= fct_reorder(Variable, -Value)))+
  geom_text(aes(x = 0, label = Variable), hjust = 0) +
  geom_text(aes(x = 1, label = label), hjust = 0)+
  theme_void()  +
  coord_cartesian(xlim = c(0,1.5))

```

```{r}
library("patchwork")
layout <- c(
  patchwork::area(t = 0, l = 0, b = 30, r = 20),
  patchwork::area(t = 0, l = 40, b = 30, r = 60),
  patchwork::area(t = 0, l = 21,b= 30, r =39)

)

X2_L + X2_R + X2_M  + plot_layout(design = layout)
```



Create a variable which selects significant health conditions to be used in the multivaraible regression model
```{r}
Conditions_X_use <- Conditions_chi |>
  mutate(
    p = as.numeric(p),
    sig = ifelse(
      as.numeric(Conditions_chi$p) < 0.05, 1, 0)
  )|>
  filter(
    sig == 1
  )

Conditions_X_use
```

```{r,include=FALSE}
# 
# #1. run model 1
#   df <- glm(Ex_rec  ~  Age + College + White_Race  + Income_60k_plus + Combat_Veteran + 
#                            TOTAL_TRAUMAS + BMI, data = thesis_NHRVS,family="binomial")
#   
# #2. summary of the model
#   df_summary <- summary(df)
#   df_sum <- tidy(df) 
# #4 Coefficients 
#   coefs_df <- abs(coef(df))
# #5. Odds ratio
#   OR_df <- exp(coef(df))
# #6. OR 95% CI
#   CI_df <- data.frame(round(exp(confint(df)),2))
# #7. P value function
#   p_val1<- cbind(df_sum$term ,df_sum$p.value)
#   adj.p <- FDR(pvalues = p_val1)
#   ADJ.p.values <- data.frame(rbind(adj.p$exclude, adj.p$select))
#   ADJ.p.values
# 
# #### Part 2. Make the table and export   
#   
# #1. Create a data frame
# tab_df <-  data.frame(cbind(
#   variable = df_sum$term[2:length(df_sum$term)],
#   Beta = coefs_df[2:length(df_sum$term)],
#   Wald = round(wald,2),
#   OR = OR_df[2:length(OR_df)],
#   CI = paste0("[",CI_df[2:length(OR_df),1], ",", CI_df[2:length(OR_df),2], "]"),
#   p = p_val1[2:length(length(p_val1[,2])),2]
# ))
# #2. left join adjusted p values
# #tab_df  <- left_join(tab_df, ADJ.p.values,by = join_by(p == p.value))
# 
# #3. 
# tab_tab <- data.frame(cbind(
#   variable = tab_df$variable,
#   Beta = tab_df$Beta,
#   Wald = tab_df$Wald,
#   OR = tab_df$OR,
#   CI = tab_df$CI,
#   p = tab_df$p
# ))
# #round the numbers
# tab_tab$Beta = round(as.numeric(tab_tab$Beta),2)
# tab_tab$Wald = round(as.numeric(tab_tab$Wald),2)
# tab_tab$OR = round(as.numeric(tab_tab$OR),2)
# tab_tab$p = tab_tab$p = round(as.numeric(tab_tab$p),4)
# 
# tab_tab[1,1] = string
# 
# output <- tab_tab[1,]
#   
#   return(output)
# }


```


For fun, Lets run some regressions with each condition seperately
```{r}
# Multivariate Logistic Multinomial Regression Function
# 
# Condition_eval_Reg<-function(Data,condition,string){
# 
# #1. run model 1
#   df <- glm(Ex_rec  ~ condition + Age + College + White_Race  + Income_60k_plus + Combat_Veteran + 
#                            TOTAL_TRAUMAS, data = Data,family="binomial")
#   
# #2. summary of the model
#   df_summary <- summary(df)
#   df_sum <- tidy(df) 
# #4 Coefficients 
#   coefs_df <- abs(coef(df))
# #5. Odds ratio
#   OR_df <- exp(coef(df))
# #6. OR 95% CI
#   CI_df <- data.frame(round(exp(confint(df)),2))
# #7. P value function
#   p_val1<- cbind(df_sum$term ,df_sum$p.value)
#   adj.p <- FDR(pvalues = p_val1)
#   ADJ.p.values <- data.frame(rbind(adj.p$exclude, adj.p$select))
#   ADJ.p.values
# 
# #### Part 2. Make the table and export   
#   
# #1. Create a data frame
# tab_df <-  data.frame(cbind(
#   variable = df_sum$term[2:length(df_sum$term)],
#   Beta = coefs_df[2:length(df_sum$term)],
#   Wald = round(wald,2),
#   OR = OR_df[2:length(OR_df)],
#   CI = paste0("[",CI_df[2:length(OR_df),1], ", ", CI_df[2:length(OR_df),2], "]"),
#   p = p_val1[2:length(length(p_val1[,2])),2]
# ))
# #2. left join adjusted p values
# #tab_df  <- left_join(tab_df, ADJ.p.values,by = join_by(p == p.value))
# 
# #3. 
# tab_tab <- data.frame(cbind(
#   variable = tab_df$variable,
#   Beta = tab_df$Beta,
#   Wald = tab_df$Wald,
#   OR = tab_df$OR,
#   CI = tab_df$CI,
#   p = tab_df$p
# ))
# #round the numbers
# tab_tab$Beta = round(as.numeric(tab_tab$Beta),2)
# tab_tab$Wald = round(as.numeric(tab_tab$Wald),2)
# tab_tab$OR = round(as.numeric(tab_tab$OR),2)
# tab_tab$p = tab_tab$p = round(as.numeric(tab_tab$p),4)
# 
# tab_tab[1,1] = string
# 
# output <- tab_tab[1,]
#   
#   return(output)
# }
#Its done!
```


```{r,include=FALS}
# ### Physical Health Conditions 
# # Conditions_reg = 0
# 
# #2. Arthritis
# Conditions_reg<-data.frame(Condition_eval_Reg(thesis_NHRVS,thesis_NHRVS$Arthritis,"Arthritis"))
# #3. Asthma
# Conditions_reg<-rbind(Conditions_reg,Condition_eval_Reg(thesis_NHRVS,thesis_NHRVS$Athsma,"Athsma"))
# #4. Cancer
# Conditions_reg<-rbind(Conditions_reg,Condition_eval_Reg(thesis_NHRVS,thesis_NHRVS$Cancer,"Cancer"))
# #5. Chronic Pain
# Conditions_reg<-rbind(Conditions_reg,Condition_eval_Reg(thesis_NHRVS,thesis_NHRVS$Chron_pain,"Chronic Pain"))
# #6. Diabetes
# Conditions_reg<-rbind(Conditions_reg,Condition_eval_Reg(thesis_NHRVS,thesis_NHRVS$Diabetes,"Diabetes"))
# #7. Heart Attack
# Conditions_reg<-rbind(Conditions_reg,Condition_eval_Reg(thesis_NHRVS,thesis_NHRVS$Hrt_atk,"Heart Attack"))
# #8. Heart Disease
# Conditions_reg<-rbind(Conditions_reg,Condition_eval_Reg(thesis_NHRVS,thesis_NHRVS$Hrt_dis,"Heart Disease"))
# #9. High Cholesterol
# Conditions_reg<-rbind(Conditions_reg,Condition_eval_Reg(thesis_NHRVS,thesis_NHRVS$High_chol,"High Cholesterol"))
# #10. Hypertension
# Conditions_reg<-rbind(Conditions_reg,Condition_eval_Reg(thesis_NHRVS,thesis_NHRVS$High_bld_press,"Hypertension"))
# #11. Kidney Disease
# Conditions_reg<-rbind(Conditions_reg,Condition_eval_Reg(thesis_NHRVS,thesis_NHRVS$Kid_dis,"Kidney Disease"))
# #12. Liver Disease
# Conditions_reg<-rbind(Conditions_reg,Condition_eval_Reg(thesis_NHRVS,thesis_NHRVS$Liv_dis,"Liver Disease"))
# #13. Migrane
# Conditions_reg<-rbind(Conditions_reg,Condition_eval_Reg(thesis_NHRVS,thesis_NHRVS$Migrane,"Migrane"))
# #14. MS
# Conditions_reg<-rbind(Conditions_reg,Condition_eval_Reg(thesis_NHRVS,thesis_NHRVS$MS,"MS"))
# #15. Osteoporosis
# Conditions_reg<-rbind(Conditions_reg,Condition_eval_Reg(thesis_NHRVS,thesis_NHRVS$Osteoporosis,"Osteoporosis"))
# #15.2 Obesity
# Conditions_reg<-rbind(Conditions_reg,Condition_eval_Reg(thesis_NHRVS$Obesity,"Obesity"))
# #16. Rheumatoid Arthritis
# Conditions_reg<-rbind(Conditions_reg,Condition_eval_Reg(thesis_NHRVS,thesis_NHRVS$Rhum_arth,"RA"))
# #17. Stroke
# Conditions_reg<-rbind(Conditions_reg,Condition_eval_Reg(thesis_NHRVS,thesis_NHRVS$Stroke,"Stroke"))
# ### Mental Health Conditions
# #18. Alcohol Use Disorder
# Conditions_reg<-rbind(Conditions_reg,Condition_eval_Reg(thesis_NHRVS,thesis_NHRVS$AUD_Current,"AUD"))
# #19. Drug Use Disorder
# Conditions_reg<-rbind(Conditions_reg,Condition_eval_Reg(thesis_NHRVS,thesis_NHRVS$DUD_Current,"DUD"))
# #20. Major Depressive Disorder 
# Conditions_reg<-rbind(Conditions_reg,Condition_eval_Reg(thesis_NHRVS,thesis_NHRVS$MDD_Current,"MDD"))
# #22 Posttraumatic Stress Disorder
# Conditions_reg<-rbind(Conditions_reg,Condition_eval_Reg(thesis_NHRVS,thesis_NHRVS$PTSD_Current,"PTSD"))
# #23 Generalized Anxiety Disorder
# Conditions_reg<-rbind(Conditions_reg,Condition_eval_Reg(thesis_NHRVS,thesis_NHRVS$GAD_Current,"GAD"))
```

```{r}
# Conditions_R_use <- Conditions_reg |>
#   mutate(
#     signifcant = ifelse(
#       as.numeric(p) < 0.05, 1, 0)
#     ) |>
#   filter(
#     signifcant == 1
#   )
# 
# Conditions_R_use
```



### Block 2: Physical Health Conditions
Block to is idential to block one with the addition of the MCS and PCS to the regression model. We are running two different regession models (i.e., one with the MCS and one with the PCS) so you can see that below. 
```{r,warning=FALSE,message=FALSE,results='hide'}
### Part 1 Physical health conditions for table
#1. Run the models
PHC_Reg<-glm(Ex_rec~
             #Covariates
             Age + College + White_Race  +
             Income_60k_plus + Combat_Veteran + 
             TOTAL_TRAUMAS +
             #Physical Health Conditions
             Athsma + Chron_pain + Diabetes+ Hrt_atk + 
             Hrt_dis + High_chol + High_bld_press + Osteoporosis + Obesity + Stroke,
             #Mental Health conditions
             # AUD_Current + DUD_Current + MDD_Current + PTSD_Current + GAD_Current,
             # Data
             data =thesis_NHRVS,
             # Specify type of regression
             family="binomial",weights = weight)


summary(PHC_Reg)
PHC_Reg_sum <- tidy(PHC_Reg) 

#2. Coefficients 
  coefs_PHC_Reg <- abs(coef(PHC_Reg))
  coefs_PHC_Reg
#3. Odds ratio
  OR_PHC_Reg <- exp(coef(PHC_Reg)[8:length(coefs_PHC_Reg)])

#4. OR 95% CI
  CI_PHC_Reg <- data.frame(round(exp(confint(PHC_Reg)[8:length(coefs_PHC_Reg),]),2))

#5. P values 
  p_val1<- cbind(PHC_Reg_sum$term[8:length(coefs_PHC_Reg)], 
                 PHC_Reg_sum$p.value[8:length(coefs_PHC_Reg)])
    adj.p <- FDR(pvalues = p_val1)
    ADJ.p.values <- data.frame(rbind(adj.p$exclude, adj.p$select))
    ADJ.p.values
    
#6. R^2 for model
  R2_PHC_Reg <- performance::r2(PHC_Reg) 
  block_2_R2 = R2_PHC_Reg[[1]] - R2_Cov_Reg[[1]]
#wald
  library(aod) # Wald test
  PHC_wald<- wald.test(b = coef(PHC_Reg),Sigma = vcov(PHC_Reg),Terms= 2:length(coefs_PHC_Reg))
  PHC_wald$result$chi2[1]
  wald <- wald.test(b = coef(PHC_Reg),Sigma = vcov(PHC_Reg),Terms=8)$result$chi2[1]
  for(i in 9:length(coefs_PHC_Reg)){
      wald <- append(wald, wald.test(b = coef(PHC_Reg),Sigma = vcov(PHC_Reg),Terms=i)$result$chi2[1])
  }
#### Part 2. Make the table and export 

#1. Create data frame
PHC_Reg_df <-  data.frame(cbind(
  variable = PHC_Reg_sum$term[8:length(PHC_Reg_sum$term)],
  Beta = coefs_PHC_Reg[8:length(coefs_PHC_Reg)],
  Wald = round(wald,2),
  OR = OR_PHC_Reg,
  CI = paste0("[",CI_PHC_Reg[,1], ", ", CI_PHC_Reg[,2], "]"),
  p = p_val1[,2]
))

PHC_Reg_df  <- left_join(PHC_Reg_df, ADJ.p.values,by = join_by(p == p.value))
PHC_Reg_tab <- data.frame(cbind(
  variable = PHC_Reg_df$variable,
  Beta = PHC_Reg_df$Beta,
  Wald = PHC_Reg_df$Wald,
  OR = PHC_Reg_df$OR,
  CI = PHC_Reg_df$CI,
  # p = PHC_Reg_df$p
  p = PHC_Reg_df$p.adjusted
))

PHC_Reg_df 

PHC_Reg_tab$Beta = round(as.numeric(PHC_Reg_tab$Beta),2)
PHC_Reg_tab$Wald = round(as.numeric(PHC_Reg_tab$Wald),2)
PHC_Reg_tab$OR = round(as.numeric(PHC_Reg_tab$OR),2)
PHC_Reg_tab$p = ifelse(as.numeric(PHC_Reg_df$p) < 0.001, "< 0.001",
  round(as.numeric(PHC_Reg_df$p),3))

#2. create the row for the R2
  paste("Block 2 R^2 =", round((R2_PHC_Reg[[1]]*100),3),"%")
  variable = c(
    "Block 2 - Physical Health Conditions",
    paste0("X^2=", round(PHC_wald$result$chi2[1],2),",p<0.001"),
    paste0("R^2 change=", round((block_2_R2[[1]]),3))  
  )

  R2TAB<-data.frame(cbind(
                      variable,Beta=NA,Wald=NA, OR =NA, CI=NA, p=NA))

#3. Bind the stuff together
  PHC_Reg_tab <- rbind(R2TAB, PHC_Reg_tab)
  Full_OR_tab <- rbind(cov_OR_tab,PHC_Reg_tab)

#4. Export
  # write_csv(PHC_Reg_tab,"~/Desktop/Coding/data/PHC_Reg_tab.csv")
  # write_csv(Full_OR_tab, "~/Desktop/Coding/data/EX_Full_OR_tab.csv")
  
  PHC_Reg_tab

```
```{r}
  knitr::kable(Full_OR_tab) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

block 3 - mental health conditions
```{r}
MHC_Reg<-glm(Ex_rec~
             #Covariates
             Age + College + White_Race  +
             Income_60k_plus + Combat_Veteran + 
             TOTAL_TRAUMAS + 
             #Physical Health Conditions
             Athsma + Chron_pain + Diabetes+ Hrt_atk + 
             Hrt_dis + High_chol + High_bld_press + Osteoporosis + Obesity + Stroke +
             #Mental Health conditions
             AUD_Current + DUD_Current + GAD_Current + MDD_Current + PTSD_Current,
             # Data
             data =thesis_NHRVS,
             # Specify type of regression
             family="binomial",weights = weight)


summary(MHC_Reg)
MHC_Reg_sum <- tidy(MHC_Reg) 

#2. Coefficients 
  coefs_MHC_Reg <- abs(coef(MHC_Reg))
  coefs_MHC_Reg
#3. Odds ratio
  OR_MHC_Reg <- exp(coef(MHC_Reg)[18:length(coefs_MHC_Reg)])

#4. OR 95% CI
  CI_MHC_Reg <- data.frame(round(exp(confint(MHC_Reg)[18:length(coefs_MHC_Reg),]),2))

#5. P values 
  p_val1<- cbind(MHC_Reg_sum$term[18:length(coefs_MHC_Reg)], 
                 MHC_Reg_sum$p.value[18:length(coefs_MHC_Reg)])
    adj.p <- FDR(pvalues = p_val1)
    ADJ.p.values <- data.frame(rbind(adj.p$exclude, adj.p$select))
    ADJ.p.values
    
#6. R^2 for model
  R2_MHC_Reg <- performance::r2(MHC_Reg)
  Block3_R2 = R2_MHC_Reg[[1]] - R2_PHC_Reg[[1]]

#wald
  library(aod) # Wald test
  MHC_wald<- wald.test(b = coef(MHC_Reg),Sigma = vcov(MHC_Reg),Terms= 2:length(coefs_MHC_Reg))
  MHC_wald$result$chi2[1]
  wald <- wald.test(b = coef(MHC_Reg),Sigma = vcov(MHC_Reg),Terms=18)$result$chi2[1]
  for(i in 19:length(coefs_MHC_Reg)){
      wald <- append(wald, wald.test(b = coef(MHC_Reg),Sigma = vcov(MHC_Reg),Terms=i)$result$chi2[1])
  }
  MHC_wald
#### Part 2. Make the table and export 

#1. Create data frame
MHC_Reg_df <-  data.frame(cbind(
  variable = MHC_Reg_sum$term[18:length(MHC_Reg_sum$term)],
  Beta = coefs_MHC_Reg[18:length(coefs_MHC_Reg)],
  Wald = round(wald,2),
  OR = OR_MHC_Reg,
  CI = paste0("[",CI_MHC_Reg[,1], ", ", CI_MHC_Reg[,2], "]"),
  p = p_val1[,2]
))

MHC_Reg_df  <- left_join(MHC_Reg_df, ADJ.p.values,by = join_by(p == p.value))
MHC_Reg_tab <- data.frame(cbind(
  variable = MHC_Reg_df$variable,
  Beta = MHC_Reg_df$Beta,
  Wald = MHC_Reg_df$Wald,
  OR = MHC_Reg_df$OR,
  CI = MHC_Reg_df$CI,
  p = MHC_Reg_df$p
  # p = MHC_Reg_df$p.adjusted
))

MHC_Reg_df 

MHC_Reg_tab$Beta = round(as.numeric(MHC_Reg_tab$Beta),2)
MHC_Reg_tab$Wald = round(as.numeric(MHC_Reg_tab$Wald),2)
MHC_Reg_tab$OR = round(as.numeric(MHC_Reg_tab$OR),2)
MHC_Reg_tab$p = ifelse(as.numeric(MHC_Reg_df$p) < 0.001, "< 0.001",
  round(as.numeric(MHC_Reg_df$p),3))

#2. create the row for the R2
  variable = c(
    "Block 3 - Mental Health Conditions",
    paste0("X^2=", round(MHC_wald$result$chi2[1],2),",p<0.001"),
    paste0("R^2 change=", round((Block3_R2[[1]]),3))  
  )

  R2TAB<-data.frame(cbind(
                      variable,Beta=NA,Wald=NA, OR =NA, CI=NA, p=NA))

#3. Bind the stuff together
  MHC_Reg_tab <- rbind(R2TAB, MHC_Reg_tab)
  Full_OR_tab <- rbind(Full_OR_tab,MHC_Reg_tab)

#4. Export
  # write_csv(MHC_Reg_tab,"~/Desktop/Coding/data/MHC_Reg_tab.csv")
  # write_csv(Full_OR_tab, "~/Desktop/Coding/data/EX_Full_OR_tab.csv")
  
  MHC_Reg_tab
  Full_OR_tab
```


Prepare for table

```{r}
#create FP df
fp_df <- data.frame(rbind(
  #Block 1
  NA,NA,NA,NA,
  arrange(cov_OR_df,desc(OR)),
  #Block 2
  NA,NA,NA,NA,
  arrange(PHC_Reg_df,desc(OR)),
  #Block 3
  NA,NA,NA,NA,
  arrange(MHC_Reg_df,desc(OR)),
  #Top row
  NA
))

fp_df
```


```{r}
fp_df <- mutate(fp_df,
    sig = ifelse(is.na(p.adjusted), NA, 
          ifelse(p.adjusted<= 0.05, 16,1)),
    Beta = round(as.numeric(fp_df$Beta),2),
    OR =  round(as.numeric(fp_df$OR),2),
    p_fig = ifelse(
      is.na(p.adjusted), NA,
      ifelse(p.adjusted < 0.001, "<0.001", 
             round(as.numeric(p.adjusted),3))),
    order = 0
    )

#make CI variables df
OR_CI <-data.frame(rbind(
    NA,NA,NA,NA,
    CI_Cov_Reg[2:length(CI_Cov_Reg$X2.5..),],
    NA,NA,NA,NA,
    CI_PHC_Reg,
    NA,NA,NA,NA,
    CI_MHC_Reg,
    NA
))
OR_CI$variables = rownames(OR_CI)

#left join CI based upon varaible names
fp_df <- left_join(fp_df,OR_CI, by = join_by(variable == variables))
colnames(fp_df)[11:12] <- c("OR_low","OR_high")

#create OR label for FP
fp_df <- mutate(fp_df,
    label = 
      #NAs      
      ifelse(is.na(OR) |is.na(CI),NA,
      #p <.05      
      ifelse(p.adjusted <= 0.05 & p.adjusted >= 0.01,
                   paste0(OR," [",OR_low,"-",OR_high,"]*"),
      #p<.01
      ifelse(p.adjusted < 0.01 & p.adjusted >= 0.001,
                   paste0(OR," [",OR_low,"-",OR_high,"]**"),
      #p<.001
      ifelse(p.adjusted < 0.001,
                   paste0(OR," [",OR_low,"-",OR_high,"]***"),
      # else (i.e., p > .05)
             paste0(OR," [",OR_low,"-",OR_high,"]")
      )))))


#assign variable names
fp_df$variable <- c(
    "Block 1",
    "Covariates",
    paste0("X^2=", round(cov_wald$result$chi2[1],2),",p<0.001"),
    paste0("R^2=", round((R2_Cov_Reg[[1]]),3)),
    "Some College",
    "Income ≥ 60k",
    "Combat Veteran",
    "White",
    "# of Traumas",
    "Age", 
    "Block 2",
    "Physical Health", 
    paste0("X^2=", round(PHC_wald$result$chi2[1],2),",p<0.001"),
    paste0("R^2 change=", round((block_2_R2[[1]]),3)),
    "Hypertension",   
    "Heart Disease",
    "Chronic Pain",
    "High Cholesterol",
    "Osteoporosis",
    "Asthma",  
    "Heart Attack",
    "Stroke", 
    "Obesity",
    "Diabetes", 
    "Block 3",
    "Mental Health",
    paste0("X^2=", round(MHC_wald$result$chi2[1],2),",p<0.001"),
    paste0("R^2 change=", round((Block3_R2[[1]]),3)),
    "Probable Current GAD",
    "Probable Current PTSD",
    "Probable Current AUD",
    "Probable Current DUD",
    "Probable Current MDD",
    "Variable")


# assign labels to top row and assign the order of varaibles
fp_df[34,2] = "Beta"
fp_df[34,3] = "Wald"
fp_df[34,13] = "OR [95% CI]"
fp_df[34,9] = "Adjusted p"
fp_df$order = c(seq(2,34,1),1)
#Final df for FP
fp_df
```


FP for logistic Regressions
```{r}
#Create order varaible in dataset to keep it the same as the regression

# FP_EX <- read_csv("~/Downloads/FP.min.dep")

#rename the variables for the figure
# install.packages("magrittr")
# library(magrittr)

EX_FP <- 
  fp_df |>
  ggplot(aes(y = reorder(variable, -order))) +
  #take away background
  theme_classic() +
  #make the forrest plot
  geom_linerange(aes(xmin=OR_low, xmax=OR_high),size = 1, show.legend = FALSE,
                color = ifelse(fp_df$p.adjusted < 0.05, "#18ab2e", "darkgrey")) +
      geom_point(aes(x=OR), shape= 16,
             size=5,show.legend = FALSE, color = "white") +
  geom_point(aes(x=OR), shape= 16,
             size=4,show.legend = FALSE,
             color = ifelse(fp_df$p.adjusted < 0.05, "#18ab2e", "darkgrey")) +



  # geom_errorbar(aes(xmin=OR_low, xmax=OR_high),width =.6, show.legend = FALSE) +
  #change x axis name
  labs(
    x="Odds Ratio",
    # title = "    Odds of Meeting Physical Activity Guidelines",
    subtitle ="Odds of Meeting Physical Activity Guidelines") +
  #adjust the dimentions. 
  coord_cartesian(ylim = c(1,length(fp_df$variable))) +
  #add a line at 1 for reference 
  geom_vline(xintercept = 1,linetype="dashed",alpha = .50) + 
  #add anotations to help suggests what each side means.
  annotate("text", x = .6, y = length(fp_df$variable) -1 , label = "Less Likely", size= 4) +
  annotate("text", x = 1.4, y = length(fp_df$variable) -1, label = "More Likely",size= 4) +
  #Git rid of the Y - Axis
    theme(axis.line.y = element_blank(),
        axis.ticks.y= element_blank(),
        axis.text.y= element_blank(),
        axis.title.y= element_blank())

EX_text <- 
  fp_df |>
  ggplot(aes(y = reorder(variable, -order))) +
  geom_text(aes(x = 0, label = variable), hjust = 0, 
        fontface = ifelse(fp_df$variable == "Variable" |
                          fp_df$variable == "Block 1"  |
                          fp_df$variable == "Block 2"  |
                          fp_df$variable == "Block 3", "bold","plain")) +
  geom_text(aes(x = 1.1, label = Beta),
        hjust = 0,
        fontface = ifelse(fp_df$Beta == "Beta", "bold","plain")) + 
  geom_text(aes(x = 1.5, label = Wald),
        hjust = 0,
        fontface = ifelse(fp_df$Wald == "Wald", "bold","plain")) +
  geom_text(aes(x = 1.9, label = label),
        hjust = 0,
        fontface = ifelse(fp_df$label == "OR [95% CI]", "bold","plain")) +
  theme_void() +     
  coord_cartesian(ylim = c(1,length(fp_df$variable)), xlim = c(0, 4))

library("patchwork")

layout <- c(
  patchwork::area(t = 0, l = 0, b = 30, r = 25),
  patchwork::area(t = 0, l = 17, b = 30, r = 26)
)

EX_text + EX_FP + plot_layout(design = layout)
#8.5 X 7.63
```


# Prep data / functions

## {.tabset}

### Create df for RIA analysis

slect statistically significant variables from logistic regression analysis
```{r df selection}
mydata <- thesis_NHRVS |>
    mutate(Obesity = ifelse(is.na(BMI), NA,
      ifelse(BMI >=30,1,0))
    ) |>
  #Select all of the variables needed for the analysis
  dplyr::select(
    #DV
       Ex_rec,
    #Covariates
       Age,College,
       Income_60k_plus,
    #Physical Health Conditions
       Athsma, Diabetes, Obesity,
    #Mental Health conditions
      DUD_Current, GAD_Current, MDD_Current, 
  )|>
    # Convert all of the varaibles to numeric
    mutate(
      Ex_rec = as.numeric(Ex_rec),
      Age = as.numeric(Age),
      College = as.numeric(College),
      Income_60k_plus = as.numeric(Income_60k_plus),
      Obesity = as.numeric(Obesity),
      Athsma = as.numeric(Athsma),
      Diabetes = as.numeric(Diabetes),
      DUD_Current = as.numeric(DUD_Current), 
      GAD_Current = as.numeric(GAD_Current),
      MDD_Current = as.numeric(MDD_Current), 
      
    )
#filter out missing data
mydata <- na.omit(mydata)
```


### Functions for bootstrapping
```{r Functions}
#### 1. logRegress -  LOGISTIC REGRESSION
# manually calculate Logistic Regression and obtain epsilon (i.e., raw relative
# R2o weight) and rescaled weights (i.e., epsilon / total R2o). The rescaled 
# weights are the relative percent of the R2o for each predictor. the rescaled
# weights add up to 100 as it is adding up to 100% of the variance explained.
logRegress<-function(mydata){
numVar<-NCOL(mydata)
Variables<-names(mydata)[2:numVar]
Y<-mydata[,1]
data.preds<-mydata[,2:length(mydata[1,])]
X<-scale(data.preds)

str(X)

X.svd<-svd(X)
Q<-X.svd$v
P<-X.svd$u
Z<-P%*%t(Q)

Z.stand<-scale(Z)

#Obtaining Lambda from equation 7 from Johnson (2000) pg 8
Lambda<-solve(t(Z.stand)%*%Z.stand)%*%t(Z.stand)%*%X

logrfit<-glm(as.factor(Y$Ex_rec)~Z.stand,family=binomial)
summary(logrfit)
unstCoefs<-coef(logrfit)
b<-unstCoefs[2:length(unstCoefs)]
LpredY<-predict(logrfit,newdata=mydata,type="response")
lYhat<-log(LpredY/(1-LpredY))#Creating logit-Y-hat
stdlYhat<-sd(lYhat)#Getting stdev of logit-Y-hat
getting.Rsq<-lm(LpredY~as.factor(Y$Ex_rec))#Getting R-sq
Rsq<-summary(getting.Rsq)$r.squared
beta<-b*((sqrt(Rsq))/stdlYhat)#Computing standardized logistic regression coefficients

epsilon<-Lambda^2%*%beta^2
R.sq<<-sum(epsilon)
PropWeights<-(epsilon/R.sq)
result <- data.frame(Variables, Raw.RelWeight=epsilon, Rescaled.RelWeight=PropWeights)
return(result)
}

#### 2. logBootstrap - BOOTSTRAP FOR RAW WEIGHTS
# This returns the bootstrapped Raw weights
# this function also calculates the bootstrapped bias and standard error
logBootstrap<-function(mydata, indices){
mydata<-mydata[indices,]
logWeights<-logRegress(mydata)
return(logWeights$Raw.RelWeight)
}

#### 3. logBootstrap_adj - BOOTSTRAP FOR RELATIVE WEIGHTS
# Same as funciton as above, but this function returns the boostrapped rescaled weights
logBootstrap_adj<-function(mydata, indices){
mydata<-mydata[indices,]
logWeights<-logRegress(mydata)
return(logWeights$Rescaled.RelWeight)
}

#### 4. logBootrand - BOOSTRAP FOR RANDOM VARAIBLE?
# I'm not sure what this is used for. Comparing if a variable is better than the 
# random variable? I can't get this function to work as it just tells me it has 
# missing variables dispite not actually having missing variables
logBootrand<-function(mydata, indices){
mydata<-mydata[indices,]
logRWeights<-logRegress(mydata)
logReps<-logRWeights$Raw.RelWeight
randWeight<-logReps[length(logReps)]
randStat<-logReps[-(length(logReps))]-randWeight
return(randStat)
}

#### 4. logBootrand_adj - BOOSTRAP FOR RANDOM VARAIBLE?
# I'm not sure what this is used for. Comparing if a variable is better than the 
# random variable? I can't get this function to work as it just tells me it has 
# missing variables dispite not actually having missing variables
logBootrand_adj<-function(mydata, indices){
mydata<-mydata[indices,]
logRWeights<-logRegress(mydata)
logReps<-logRWeights$Rescaled.RelWeight
randWeight<-logReps[length(logReps)]
randStat<-logReps[-(length(logReps))]-randWeight
return(randStat)
}

#### 5. mybootci -  EXTRACT THJE 95% CI'S 
# Extracts the  95% BCa ci for a given variable (i.e., index)
mybootci<-function(x){
boot.ci(logBoot,conf=0.95, type="bca", index=x)
}

#### 6. runBoot - EXTRACT THE 95% CI'S FOR EACH VARIABLE
# This function extracts the CI's for each given varaible in the bootstrap and 
# returns a df called test2 which contains the CI's and some other stats.
runBoot<-function(num){
INDEX<-1:num
test<-lapply(INDEX, FUN=mybootci)
test
test2<-t(sapply(test,'[[',i=4))
return(test2)
# CIresult<<-data.frame(Variables = coln, CI.Lower.Bound=test2[,4],CI.Upper.Bound=test2[,5])
}

#### 7. myRbootci - EXTRACT 95% CI W/RANDOM VARIABLE
# HAvent been able to get this to work, I think its the same as above, but w/
# a random variable?
myRbootci<-function(x){
boot.ci(logRBoot,conf=0.95,type="bca",index=x)
}

#### 8. runRBoot - EXTRACT THE 95% CI FOR EACH VARIABLE W/RANDOM
# HAvent been able to get this to work, I think its the same as above, but w/
# a random variable?
runRBoot<-function(num){
INDEX<-1:num
test<-lapply(INDEX,FUN=myRbootci)
test2<-t(sapply(test,'[[',i=4))
return(test2)
}
```

# Running the Relative Importance Analysis / Relative Weight Analysis

## {.tabset}

### Part 1 RIA/RWA
The code below uses the functions above to caculate how important each variable 
is to the varaince Phsyical Activity.
```{r RIA}
#1.1 Run logRegress function
result <- logRegress(mydata)

#1.2 Save results from logRegress function
RW.Results<-result
RSQ.o<-R.sq

RW.Results <- result |>
  #order the varaibles based upon the scaled weights
  # arrange(-Rescaled.RelWeight) |>
  #create percent varaibles
  mutate(Rescaled.RelWeight.percent = round((Rescaled.RelWeight*100),2),
         Raw.percent = round(Raw.RelWeight*100,4)
  )

# 1.3 display results of relative weight analysis
knitr::kable(RW.Results) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
RW.Results

```



### Part 2 Bootstrapping RIA/RWA

Use bootstrapping functions to obtain 95% CI's for raw and rescaled weights.
```{r Bootstrap RIA 1,results='hide',warning=FALSE,message=FALSE,error=FALSE}
#2.1 Set seed for anlaysis
set.seed(6624)

#2.2 Boot function to bootstrap for raw weights CI
logBoot <-boot(mydata, # Data
              logBootstrap, # Statistic
              10000) # R / number of times

#2.3 Extract RIA/RWA statistic with bias and SE
tidy_boot <- tidy(logBoot)
  # You can obtain confidence intervals using the SE (+/-1.96*SE)
  #CI.Results_tidy <- tidy(logBoot_B3,conf.int=TRUE)

#2.4 assign the # of variables (columns) in mydata to a variable named numVar
numVar = NCOL(mydata)

#2.5 Run the boot.ci function to obtain the CI for the model
logci<-boot.ci(logBoot,conf=0.95, type="bca")

#2.6 Run runBoot function and extract 95% CI for the IV's in the model.
test2 <- runBoot(length(mydata[,2:numVar]))
```

Create df and export to csv so you don't need to run stats every time
```{r Bootstrap RIA 2,warning=FALSE,message=FALSE,error=FALSE}
#2.7 Create df with 95% CI
CI.Result<-data.frame(Variables=colnames(mydata[2:10]), CI.Lower.Bound=test2[,4],CI.Upper.Bound=test2[,5])

#2.8 Save df as a csv so you can call it again in the future
# write_csv(CI.Result, "/Users/troyh/Downloads/CI.Result")
# write_csv(tidy_boot, "/Users/troyh/Downloads/tidy_boot")

#2.9 Here is the output using tidy()
knitr::kable(tidy_boot) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

#2.10 here is the output using boot.ci() abnd runBoot()
knitr::kable(CI.Result) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```


Run the same code again but for the rescaled weights
```{r Bootstrap RIA 3,results='hide',warning=FALSE,message=FALSE,error=FALSE}
#2.11 run bootstrap anlysis for rescaled CI so it can be used in figures
logBoot_adj <-boot(mydata, # Data
              logBootstrap_adj, # Statistic
              10000) # R / number of times

numVar = NCOL(mydata)
mydata <- mydata
logBoot <-logBoot_adj
logci<-boot.ci(logBoot,conf=0.95, type="bca")
numVar = length(mydata)
test2 <- runBoot(length(mydata[,2:numVar]))
tidy_boot_res <- tidy(logBoot_adj)
#DF
CI.Result.res<<-data.frame(Variables=colnames(mydata[2:10]), CI.Lower.Bound=test2[,4],CI.Upper.Bound=test2[,5])
# write_csv(CI.Result.res, "/Users/troyh/Downloads/CI.Result.res")
# write_csv(tidy_boot_res, "/Users/troyh/Downloads/tidy_boot_res")
```



The code below is used for significance testing. If the output has a negative value that variable is **not statistically significant**. This code adds a random varaible into the data frame, and runs the analysis with this as a reference for other variables.
```{r Random Boot function,results='hide',echo=FALSE,warning=FALSE,message=FALSE,error=FALSE}
#Bootstrapped Confidence interval tests of Significance
#Please be patient -- This can take a few minutes to run
logRegress<-function(mydata){
numVar<-NCOL(mydata)
Variables<-names(mydata)[2:numVar]
Y<-mydata[,1]
data.preds<-mydata[,2:length(mydata[1,])]
X<-scale(data.preds)

str(X)

X.svd<-svd(X)
Q<-X.svd$v
P<-X.svd$u
Z<-P%*%t(Q)

Z.stand<-scale(Z)

#Obtaining Lambda from equation 7 from Johnson (2000) pg 8
Lambda<-solve(t(Z.stand)%*%Z.stand)%*%t(Z.stand)%*%X 

logrfit<-glm(as.factor(Y)~Z.stand,family=binomial)
summary(logrfit)
unstCoefs<-coef(logrfit)
b<-unstCoefs[2:length(unstCoefs)]
LpredY<-predict(logrfit,newdata=mydata,type="response")
lYhat<-log(LpredY/(1-LpredY))#Creating logit-Y-hat
stdlYhat<-sd(lYhat)#Getting stdev of logit-Y-hat
getting.Rsq<-lm(LpredY~as.factor(Y))#Getting R-sq
Rsq<-summary(getting.Rsq)$r.squared
beta<-b*((sqrt(Rsq))/stdlYhat)#Computing standardized logistic regression coefficients

epsilon<-Lambda^2%*%beta^2
R.sq<<-sum(epsilon)
PropWeights<-(epsilon/R.sq)
result <- data.frame(Variables, Raw.RelWeight=epsilon, Rescaled.RelWeight=PropWeights)
return(result)
}
```


```{r Random Boot 1,results='hide',warning=FALSE,message=FALSE,error=FALSE}
#2.12 set seed for reproduceability
set.seed(6624)
#2.13 assign random variables with a mean of 0 and an SD of 1
randVar<-rnorm(length(mydata$Ex_rec), mean = 0, sd = 1)
#2.14 bind it to df
randData<-cbind(mydata,randVar)
#2.15 run random varaible bootstrap RIA
numVar = ncol(randData)
logRBoot<-boot(randData,logBootrand, 10000)
logRci<-boot.ci(logRBoot,conf=0.95, type="bca")
test2 <- runRBoot(length(randData[,2:(numVar-1)]))
#2.16 save output
CI.Result.rand <<-data.frame(Variables=colnames(mydata[2:10]), CI.Lower.Bound=test2[,4],CI.Upper.Bound=test2[,5])

#2.17 view results
knitr::kable(CI.Result.rand) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```



Negative lower bound CI's indicate non significance. You can see that Athsma, DUD current, GAD current, and MDD current have **a negative lower bound CI**, resulting in these variables _not_ being significant. 

### Part 3 join results into on df and create variables for Figures

```{r rename df}
# CI.Result <- read.csv("/Users/troyh/Downloads/CI.Result")
# CI.Result.res <- read.csv("/Users/troyh/Downloads/CI.Result.res")
# tidy_boot_res <- read_csv("/Users/troyh/Downloads/tidy_boot_res")
# tidy_boot <- read_csv("/Users/troyh/Downloads/tidy_boot")

#BCa Confidence Intervals around the raw weights

# rename varaibles per analysis as Raw or Rescale
colnames(CI.Result) <- paste0(colnames(CI.Result),"_Raw")
colnames(CI.Result.res) <- paste0(colnames(CI.Result.res),"_Rescale")
```


```{r data wrangle}
#left join bootstraped results to RW.Results df
RW.Results <- left_join(RW.Results,CI.Result, by = join_by(Variables == Variables_Raw))
RW.Results <- left_join(RW.Results,CI.Result.res, by = join_by(Variables == Variables_Rescale))

#left join tidy bootstrap dataset
RW.Results <- left_join(RW.Results,tidy_boot_res, by = join_by(Rescaled.RelWeight == statistic))

#create new df with CIs and values as %
wt_df <- RW.Results |>
  mutate(
  # make raw values that are rounded and %'s
    raw.CI = paste0("[", round(CI.Lower.Bound_Raw*100,2), ", ", 
                    round(CI.Upper.Bound_Raw*100,2), "]"),
    raw.CI.low = round(CI.Lower.Bound_Raw*100,2),
    raw.CI.high = round(CI.Upper.Bound_Raw*100,2),
  # make rescale values that are rounded and %'s 
    res.CI = paste0("[", round(CI.Lower.Bound_Rescale*100,2), ", ", 
                    round(CI.Upper.Bound_Rescale*100,2), "]"),
    res.CI.low = round(CI.Lower.Bound_Rescale*100,2),
    res.CI.high = round(CI.Upper.Bound_Rescale*100,2),
  #make a variable that will be used as an order for figures
    order = NA,
  #make variabels that can be used for ggtext
    Raw.wt.text = round(Raw.percent,2),
    Res.wt.text = round(Rescaled.RelWeight.percent,2),
  #manually calculate CI's based upon SE from bootstrapped.
    res.CI.low.man.stat = (Rescaled.RelWeight - (1.96*std.error)),
    res.CI.high.man.stat = (Rescaled.RelWeight + (1.96*std.error)),
    res.CI.man = paste0("[", round(res.CI.low.man.stat*100,2), ", ", 
                    round(res.CI.high.man.stat*100,2), "]"),
    res.CI.low.man = round(res.CI.low.man.stat*100,2),
    res.CI.high.man = round(res.CI.high.man.stat*100,2),
    Dist = Rescaled.RelWeight.percent - res.CI.high.man,
    Low1 = Rescaled.RelWeight.percent - ((1/3)*Dist),
    High1 = Rescaled.RelWeight.percent + ((1/3)*Dist),
    Low2 = Rescaled.RelWeight.percent - ((2/3)*Dist),
    High2 = Rescaled.RelWeight.percent + ((2/3)*Dist),
  )

wt_df

#assign variables and put them at the top
  wt_df[10,]   = NA  
  wt_df[10,1]  = "Variable"
  wt_df[10,12] = "95% CI"
  wt_df[10,15] = "95% CI"
  wt_df[10,19] = "R2o (%)"  
  wt_df[10,20] = "Rescaled (%)" 
  wt_df[10,23] = "95% CI"
  wt_df <- arrange(wt_df,-Rescaled.RelWeight)
  wt_df$order  = c(seq(2,10,1),1)
  wt_df <- arrange(wt_df,order)
  
```

# Visualize analysis with barplots

## {.tabset}

### Barplot w/ manual CI's

I used patchwork to combine `ggtext()` and the `geom_bar()` figures. The figure 
below is manually calculated 95% CI's for the rescaled weights using `tidy()` to extract the bootstrapped standard errors.

```{r}
# wt_df <- readxl::read_excel("~/Downloads/plot_test.xlsx")
wt_df
```



```{r fig 1,fig.width=8,warning=FALSE,message=FALSE}
# wt_df$Variables = c("Variable","Age", "Some College", "Income ≥ 60k", "Asthma", "Diabetes",
                    # "Obesity", "Current DUD", "Current GAD", "Current MDD")

wt_plot_man <- wt_df |>
  ggplot(aes(x=reorder(Variables,-order),y=Rescaled.RelWeight.percent)) +
  geom_bar(stat = "identity", color = "Black", width = .75, fill = "#18ab2e" )+
  geom_errorbar(aes(ymin=res.CI.low.man, ymax=res.CI.high.man,width =.3, show.legend = FALSE)) +
  labs(
    # title = "     Relative Weight (%) Of Predictors On Physical Activity",
    subtitle ="Relative Weight (%) Of Predictors On Physical Activity" 
      #"      RIA with 10000 bootstrapped confidence intervals"
  ) +
  theme_classic() +
  xlab('Variable')+
  ylab('Weight (%) of variance (R2o) in physical activity')+
  ylim(-5,50)+
    geom_text(aes(y=-3, label="Non-Significant Weight", x=3), colour="#ab0e0e", angle=90, vjust = -1, size=4)+
  geom_segment(aes(x = 5, y = -3.5, xend = 1, yend = -3.5),color="#ab0e0e")+
  # geom_text(aes(label = wt_text), vjust =.5, hjust = -.1, color = "black")+
  coord_flip()  +
    theme(axis.line.y = element_blank(),
        axis.ticks.y= element_blank(),
        axis.text.y= element_blank(),
        axis.title.y= element_blank())

wt_text_man <- 
  wt_df |>
  ggplot(aes(y = reorder(Variables, -order))) +
  geom_text(aes(x = 0, label = Variables), hjust = 0, 
        fontface = ifelse(wt_df$Variables == "Variable", "bold","plain")) +
  geom_text(aes(x = 1.1, label = Res.wt.text),
        hjust = 0,
        fontface = ifelse(wt_df$Res.wt.text == "Rescaled (%)", "bold","plain")) +
  geom_text(aes(x = 2, label = res.CI.man),
        hjust = 0,
        fontface = ifelse(wt_df$res.CI.man == "95% CI", "bold","plain")) +
  theme_void() +     
  coord_cartesian(ylim = c(1,length(wt_df$Variables)), xlim = c(0, 4))
library("patchwork")
layout <- c(
  patchwork::area(t = 0, l = 0, b = 30, r = 30),
  patchwork::area(t = 0, l = 22, b = 30, r = 40)
)

wt_text_man + wt_plot_man + plot_layout(design = layout)
```

```{r,warning=FALSE}
wt_df$Variables = c("Variable","Age", "Some College", "Income ≥ 60k", "Asthma", "Diabetes",
                    "Obesity", "Current DUD", "Current GAD", "Current MDD") 

wt_plot1 <-
  wt_df |>
  ggplot(aes(y = reorder(Variables, -order))) +  #, color = as.factor(sig))) +
  #take away background
  theme_classic() +
  #make the forrest plot
  geom_linerange(aes(xmin=res.CI.low.man, xmax=res.CI.high.man),size = 1, show.legend = FALSE, color = ifelse(wt_df$res.CI.low.man < 0,                       "darkgrey", "darkgreen"))+
  geom_linerange(aes(xmin=Low2, xmax=High2),size = 2, show.legend = FALSE,color = ifelse(wt_df$res.CI.low.man < 0, "darkgrey", "darkgreen"))+
  geom_linerange(aes(xmin=Low1, xmax=High1),size = 3, show.legend = FALSE, color = ifelse(wt_df$res.CI.low.man < 0, "darkgrey", "darkgreen"))+
  #using a box
  # geom_point(aes(x=Rescaled.RelWeight.percent), shape= 15,
             # size=4,show.legend = FALSE, color="orange")+
  #using circle
  geom_point(aes(x=Rescaled.RelWeight.percent), shape= 16,
             size=7.5,show.legend = FALSE,color="white")+
  geom_point(aes(x=Rescaled.RelWeight.percent), shape= 16,
             size=6,show.legend = FALSE, color=
               ifelse(wt_df$res.CI.low.man < 0, "darkgrey", "darkgreen"))+

  #using diamond
  # geom_point(aes(x=Rescaled.RelWeight.percent), shape= 18, 
  #            size=6.5,show.legend = FALSE, color="orange")+
#change x axis name
  labs(
    x="Weight (%) of variance (R2o) in physical activity",
    subtitle =".        Relative Weight (%) Of Predictors On Physical Activity" ) +
  #adjust the dimentions.
  coord_cartesian(ylim = c(1,length(wt_df$Variables))) +
  #add a line at 1 for reference
  geom_vline(xintercept = 0,linetype="dashed",alpha = .50) +
  #add anotations to help suggests what each side means.
    theme(axis.line.y = element_blank(),
        axis.ticks.y= element_blank(),
        axis.text.y= element_blank(),
        axis.title.y= element_blank())
wt_plot1
```


```{r,warning=FALSE}
wt_df$Variables = c("Age", "Some College", "Income ≥ 60k", "Asthma", "Diabetes",
                    "Obesity", "Current DUD", "Current GAD", "Current MDD", "Variable")

wt_plot2 <-
  wt_df |>
  ggplot(aes(y = reorder(Variables, -order))) +  #, color = as.factor(sig))) +
  #take away background
  theme_classic() +
  #make the forrest plot
  geom_linerange(aes(xmin=res.CI.low.man, xmax=res.CI.high.man),size = 1, show.legend = FALSE,color = "#18ab2e")+
  geom_linerange(aes(xmin=Low2, xmax=High2),size = 2, show.legend = FALSE,color = "#18ab2e")+ 
  geom_linerange(aes(xmin=Low1, xmax=High1),size = 3, show.legend = FALSE, color = "#18ab2e")+
  #using a box
  # geom_point(aes(x=Rescaled.RelWeight.percent), shape= 15,
             # size=4,show.legend = FALSE, color="orange")+
  #using circle
      geom_point(aes(x=Rescaled.RelWeight.percent), shape= 18,
             size=7,show.legend = FALSE,color="white") + 
  geom_point(aes(x=Rescaled.RelWeight.percent), shape= 18,
             size=5.5,show.legend = FALSE, color = "#18ab2e")+
#change x axis name
  labs(
    x="Weight (%) of variance (R2o) in physical activity",
    subtitle =".        Bootstraped Weight (%) Of Predictors On Physical Activity" ) +
  #adjust the dimentions.
  coord_cartesian(ylim = c(1,length(wt_df$Variables))) +
  #add a line at 1 for reference
  geom_vline(xintercept = 0) +
  geom_text(aes(x=-3, label="No Significant Weight", y=3), colour="black", angle=90, vjust = -.7, size=3.5)+
  geom_text(aes(x=30, label= "More % of Weight", y=5), colour="black", size =3.5)+
  #add anotations to help suggests what each side means.
    theme(axis.line.y = element_blank(),
        axis.ticks.y= element_blank(),
        axis.text.y= element_blank(),
        axis.title.y= element_blank())

wt_plot2
```


```{r,warning=FALSE}
wt_text_man <- 
  wt_df |>
  ggplot(aes(y = reorder(Variables, -order))) +
  geom_text(aes(x = 0, label = Variables), hjust = 0, 
        fontface = ifelse(wt_df$Variables == "Variable", "bold","plain")) +
  geom_text(aes(x = 1.1, label = Res.wt.text),
        hjust = 0,
        fontface = ifelse(wt_df$Res.wt.text == "Rescaled (%)", "bold","plain")) +
  geom_text(aes(x = 2, label = res.CI.man),
        hjust = 0,
        fontface = ifelse(wt_df$res.CI.man == "95% CI", "bold","plain")) +
  theme_void() +     
  coord_cartesian(ylim = c(1,length(wt_df$Variables)), xlim = c(0, 4))
library("patchwork")
layout <- c(
  patchwork::area(t = 0, l = 0, b = 30, r = 30),
  patchwork::area(t = 0, l = 24, b = 30, r = 40)
)

wt_text_man + wt_plot2 + plot_layout(design = layout)
```



### Barplot w/ Robbs Code

This figure is the rescaled weights Barplot using my `mybootci()` and `runBoot()` to obtain the 95% CI. I can't figure out why the 95% CI is skewed.

```{r,fig.width=8,warning=FALSE,include=FALSE}
wt_plot <- 
  wt_df |>
  arrange(wt_df,order) |>
  ggplot(aes(x=stats::reorder(Variables,-order),y=Rescaled.RelWeight.percent)) +
  geom_bar(stat = "identity", color = "Black", width = .75, fill = "#91c3e6" )+
  geom_errorbar(aes(ymin=res.CI.low, ymax=res.CI.high,width =.3, show.legend = FALSE)) +
  labs(
    # title = "     Relative Weight (%) Of Predictors On Physical Activity",
    subtitle ="Relative Weight (%) Of Predictors On Physical Activity" 
      #"      RIA with 10000 bootstrapped confidence intervals"
  ) +
  theme_classic() +
  xlab('Variable')+
  ylab('Weight (%) of variance (R2o) in physical activity')+
  ylim(0,50)+
  # geom_text(aes(label = wt_text), vjust =.5, hjust = -.1, color = "black")+
  coord_flip()  +
    theme(axis.line.y = element_blank(),
        axis.ticks.y= element_blank(),
        axis.text.y= element_blank(),
        axis.title.y= element_blank())

wt_text <- 
  wt_df |>
  ggplot(aes(y = reorder(Variables, -order))) +
  geom_text(aes(x = 0, label = Variables), hjust = 0, 
        fontface = ifelse(wt_df$Variables == "Variable", "bold","plain")) +
  geom_text(aes(x = 1.1, label = Res.wt.text),
        hjust = 0,
        fontface = ifelse(wt_df$Res.wt.text == "Rescaled (%)", "bold","plain")) +
  geom_text(aes(x = 2, label = res.CI),
        hjust = 0,
        fontface = ifelse(wt_df$res.CI == "95% CI", "bold","plain")) +
  theme_void() +     
  coord_cartesian(ylim = c(1,length(wt_df$Variables)), xlim = c(0, 4))

library("patchwork")

layout <- c(
  patchwork::area(t = 0, l = 0, b = 30, r = 30),
  patchwork::area(t = 0, l = 22, b = 30, r = 40)
)
```


```{r,fig.width=8,warning=FALSE}
wt_text + wt_plot + plot_layout(design = layout)
```

## Interactions of health conditions on physical activity recomendations
```{r}
# install.packages("bruceR")
library(bruceR)
# assign a vector of covariates to be used in analysis
covs = c("White_Race",
  "Combat_Veteran", "College", "Income_60k_plus", "TOTAL_TRAUMAS")

##### AGE -> EX

#Age*Obesity
PROCESS(thesis_NHRVS, # Data
  x="Age",  # Health conditoin
  mods = "BMI",  # Moderator
  y="MET_min", # outcome variable
  covs = c("White_Race","Income_60k_plus","College","Combat_Veteran", "TOTAL_TRAUMAS")) # covariates

#Age*College
PROCESS(thesis_NHRVS,
  x="Age", 
  mods = "College",
  y="MET_min",
  covs = c("White_Race","Combat_Veteran", "TOTAL_TRAUMAS"))

  #This was already done above, but for referene

#Age*Diabetes
PROCESS(thesis_NHRVS,
  x="Age", 
  mods = "Diabetes",
  y="MET_min",
  covs = c("White_Race","Income_60k_plus","College","Combat_Veteran", "TOTAL_TRAUMAS"))

##### diabetes -> EX

#Diabetes*College
PROCESS(thesis_NHRVS,
  x="Diabetes", 
  mods = "College",
  y="MET_min",
  covs = c("White_Race","Combat_Veteran", "TOTAL_TRAUMAS"))

##### BMI -> EX
#BMI*College
PROCESS(thesis_NHRVS,
  x="BMI", 
  mods = "College",
  y="MET_min",
  covs = c("White_Race","Combat_Veteran", "TOTAL_TRAUMAS"))

#BMI*College
PROCESS(thesis_NHRVS,
  x="BMI", 
  mods = "Diabetes",
  y="MET_min",
  covs = c("White_Race","Combat_Veteran", "TOTAL_TRAUMAS"))
```

```{r}
#BMI*GAD - insignificant
#BMI*MDD - insignificant
#BMI*PTSD - insignificant 
#BMI*AUDIT - insignificant 

#Diaabetes*GAD - insignificant
#Diabetes*MDD - insignificant
#Diabetes*PTSD - insignificant 
#Diabetes*AUDIT - insignificant 

#check if total health conditions mediates or moderates exercise (met mins/sufficient)

library(bruceR)

covs = c("White_Race",
  "Combat_Veteran", "Income_60k_plus", "TOTAL_TRAUMAS")

PROCESS(thesis_NHRVS,
  x="Age",
  mods = "Total_HC",
  y="MET_min_W",
  covs = covs)

```

Random forrest?
```{r}


rf_df <- NHRVS_2019 |>
  dplyr::select(
#Sociodem
Age,Male_Gender,White_Race,SomeCollege_or_Higher,Married_Partnered,Income_60k_plus,BMI,
#Military
Combat_Veteran,Retired, #Years_in_Military
#Health_stuff
SUM_Concussion_Items, Concussion_PosScreen,
#trauma_stuff
TOTAL_TRAUMAS,DIRECT_TRAUMA_EXPS,ACES_TOTAL,YrsSinceWorstTrauma,SUM_PM_PCL,PM_PCL_31,POSTTRAUMATIC_GROWTH_TOTAL,
#PTG
PTGI_RELATING_TO_OTHERS,PTGI_NEW_POSSIBILITIES,PTGI_PERSONAL_STRENGTH,PTGI_SPIRITUAL_CHANGE,PTGI_APPRECIATION_OF_LIFE,
#Current psychiatric
MDD_SYMPTOMS_CURRENT:SI_SYMPTOMS_CURRENT,AUDIT_SUM,
#PHYSICAL HEALTH 
NUMBER_MEDICAL_CONDITIONS:INSOMNIA_SEVERITY,MOS_COGNITIVE_FUNCTIONING,
#PERSONALITY_CHARACTERISTICS
EXTRAVERSION:IMPULSIVENESS,
#Protective_psychosocial
RESILIENCE:GRIT,
#SOCIAL SUPPORT
STRUCTURAL_SOCIAL_SUPPORT:ALTRUISTIC_BEHAVIOR,
#expectations_regarding_aging
POSITIVE_EXPECTATIONS_REGARDING_AGING,
PositiveERA_physical:PositiveERA_cognitive,
#functioning
SF8_PHYSFXN_FINAL:SF8_MENTALHEALTH_FINAL,
#MENTAL HEALTH TREATMENT
Lifetime_MH_Tx, Duration,
    #Physical health Variables_________
      # ANY_ADL_DISABILITY,ANY_IADL_DISABILITY,Any_Disability,tot_phc,Any_PHC,
      Q22A_1,Q22A_2,
      Q22A_3,Q22A_4,Q22A_5,Q22A_6,Q22A_7,Q22A_8,Q22A_9,Q22A_10,Q22A_11,Q22B_1,
      Q22B_2,Q22B_3,Q22B_4,Q22B_5,
    #Exercise variables ___________
      godin_mild_winsor,godin_Mod_winsor,godin_Stren_winsor,godin_total_ac,
    #Education variables __________\
    ppeduc, ppeducat
)
#Rename variabes
rf_df<-rename(rf_df,
#Rename variabes

      God_mild = godin_mild_winsor,
      God_mod = godin_Mod_winsor,
      God_stren = godin_Stren_winsor,
      College = SomeCollege_or_Higher,
      Arthritis = Q22A_1,
      Athsma =  Q22A_2,
      Cancer = Q22A_3,
      Chron_pain = Q22A_4,
      Liv_dis = Q22A_5,
      Diabetes = Q22A_6,
      Hrt_dis = Q22A_7,
      Hrt_atk = Q22A_8,
      High_chol = Q22A_9,
      High_bld_press = Q22A_10,
      Kid_dis = Q22A_11,
      Migrane = Q22B_1,
      MS = Q22B_2,
      Osteoporosis = Q22B_3,
      Rhum_arth = Q22B_4,
      Stroke = Q22B_5,
      edu = ppeduc,
      Education_Cat = ppeducat,
     Therapy_Duration = Duration
) |>
  # First Create all of the variables
  mutate(rf_df, 
    # Exercise variables
         Ex_time = (God_mild + God_mod + God_stren)*15,
         HCS = God_mild*3 + God_mod*5 + God_stren*9,
            # Tells us how long people exercised for.
         MET_min = godin_total_ac* 15,
         MET_min_W = ifelse(MET_min > 2500, 2500, MET_min),
            # Total METs per week times the duration of exercise
         Ex_rec = as.factor(ifelse(MET_min >= 500, "Sufficient", "Inufficient")),
         Therapy_Duration = Therapy_Duration /3600
    
  ) 
rf_df<- mutate(rf_df,
      #Physical health variables
           # Any_Disability = as.factor(Any_Disability),
           Arthritis = as.factor(Arthritis),
           Athsma = as.factor(Athsma),
           Cancer = as.factor(Cancer),
           Chron_pain = as.factor(Chron_pain),
           Liv_dis = as.factor(Liv_dis),
           Diabetes = as.factor(Diabetes),
           Hrt_dis = as.factor(Hrt_dis),
           Hrt_atk = as.factor(Hrt_atk),
           High_chol = as.factor(High_chol),
           High_bld_press = as.factor(High_bld_press),
           Kid_dis = as.factor(Kid_dis),
           Migrane = as.factor(Migrane),
           MS = as.factor(MS),
           Osteoporosis = as.factor(Osteoporosis),
           Rhum_arth = as.factor(Rhum_arth),
           Stroke = as.factor(Stroke),
           Male_Gender = as.factor(Male_Gender), 
           Married_Partnered = as.factor(Married_Partnered),
           White_Race = as.factor(White_Race),
           College = as.factor(College),
           Income_60k_plus = as.factor(Income_60k_plus),
           Combat_Veteran = as.factor(Combat_Veteran),
    #Education variables
      Education_Cat = as.factor(Education_Cat) 
    ) 


rf_df<- mutate(rf_df, 
        Married_Partnered = recode(Married_Partnered,
                         "0" = "Married_Partnered",
                         "1" = "Single"),
        Male_Gender = as.factor(Male_Gender),
        Male_Gender = recode(Male_Gender,
                         "0" = "Female",
                         "1" = "Male"),
        White_Race = recode(White_Race,
                         "0" = "Not_White",
                         "1" = "White"),
        College = recode(College,
                         "0" = "No_Colege",
                         "1" = "Some_Colege"),
        Income_60k_plus = recode(Income_60k_plus,
                         "0" = "Under_60k",
                         "1" = "OVer_60k"),
        Combat_Veteran = as.factor(Combat_Veteran),
        Combat_Veteran = recode(Combat_Veteran,
                         "0" = "No_Combat",
                         "1" = "Combat"),
        Education = ifelse(edu <= 9, "HS Education or Less",
                    ifelse(edu == 10 | edu == 11, "Some College",
                    ifelse(edu == 12, "Bacholars Degree", "Advanced Degree"
                    ))),
      #   Education = as.factor(Education),
      Obesity = ifelse(is.na(BMI), NA,
       ifelse(BMI >=30,1,0)),
       Obesity = as.factor(Obesity)
      #      ) 
        )

#Filter out NA values

rf_df <- rf_df |>
  dplyr::select(
    Ex_rec, BMI,SomeCollege_or_Higher,
    Age:Combat_Veteran,
    Retired,Concussion_PosScreen:Stroke
  ) |>
  na.omit(rf_df)



# set.seed(123)
# # install.packages('rsample')
# library(rsample)
# # Split the data into training and testing sets
# data_split <- initial_split(rf_df, prop = 0.75)
# train_data <- training(data_split)
# test_data <- testing(data_split)
# test_data

set.seed(123)
library(randomForest)
rf <-randomForest(Ex_rec~.,data=rf_df, ntree=500,importance = TRUE) 
confusion.mat = rf$confusion[1:2,1:2]
confusion.mat
Accuracy = sum( diag(confusion.mat) )/sum(confusion.mat)
Sensitivity = confusion.mat["Inufficient", "Inufficient"]/
  sum(confusion.mat["Inufficient", ])
Specificity = confusion.mat["Sufficient", "Sufficient"]/
  sum(confusion.mat["Sufficient", ])
c(Accuracy, Sensitivity, Specificity)

print(rf)

library(rpart)
library(rpart.plot)

mtry <- tuneRF(rf_df[-1],rf_df$Ex_rec, ntreeTry=500,
               stepFactor=1.5,improve=0.01, trace=TRUE, plot=TRUE)
best.m <- mtry[mtry[, 2] == min(mtry[, 2]), 1]
print(mtry)
print(best.m)

set.seed(71)
EX_RF_Model2 <-randomForest(Ex_rec~.,data=rf_df, mtry=best.m, ntree=500,importance = TRUE)
print(EX_RF_Model)
#Evaluate variable importance
importance(EX_RF_Model)
varImpPlot(EX_RF_Model)
varImpPlot(EX_RF_Model,type = 1)
varImpPlot(EX_RF_Model,type = 2)
varImpPlot(EX_RF_Model2,type = 1)
varImpPlot(EX_RF_Model2,type = 2)
```


```{r}
library(bruceR)

############################## bmi ###############################
### OPENNESS TO EXPERIENCES
PROCESS(rf_df, # Data
  x="BMI",  # Health conditoin
  mods = "OPENNESS_TO_EXPERIENCES",  # Moderator
  y="Ex_rec", # outcome variable
  covs = c("White_Race","Income_60k_plus","College","Combat_Veteran", "TOTAL_TRAUMAS"))

### CURIOSITY 
PROCESS(rf_df, # Data
  x="BMI",  # Health conditoin
  mods = "CURIOSITY",  # Moderator
  y="Ex_rec", # outcome variable
  covs = c("White_Race","Income_60k_plus","College","Combat_Veteran", "TOTAL_TRAUMAS"))

### sOMATIC SYMPTOMS
PROCESS(rf_df, # Data
  x="BMI",  # Health conditoin
  mods = "SOMATIC_SYMPTOMS",  # Moderator
  y="Ex_rec", # outcome variable
  covs = c("White_Race","Income_60k_plus","College","Combat_Veteran", "TOTAL_TRAUMAS"))

#PTG

PROCESS(rf_df, # Data
  x="BMI",  # Health conditoin
  mods = "POSTTRAUMATIC_GROWTH_TOTAL",  # Moderator
  y="Ex_rec", # outcome variable
  covs = c("White_Race","Income_60k_plus","College","Combat_Veteran", "TOTAL_TRAUMAS"))

```

```{r}
############################## age ###############################


### sOMATIC SYMPTOMS
PROCESS(rf_df, # Data
  x="Age",  # Health conditoin
  mods = "SOMATIC_SYMPTOMS",  # Moderator
  y="Ex_rec", # outcome variable
  covs = c("White_Race","Combat_Veteran", "TOTAL_TRAUMAS"))
```



```{r}
# # Create a decision tree model specification
# install.packages('tidymodels')
# library("tidymodels")
# tree_spec <- decision_tree() %>%
#  set_engine("rpart") %>%
#  set_mode("classification")
# 
# # Fit the model to the training data
# tree_fit <- tree_spec %>%
#  fit(Ex_rec ~ ., data = train_data)
# 
# 
# # Make predictions on the testing data
# predictions <- tree_fit %>%
#  predict(test_data) %>%
#  pull(.pred_class)
# 
# metric_set
# metrics <- metric_set(roc_auc, pr_auc, accuracy)
# model_performance <- test_data %>%
#  mutate(predictions = predictions) %>%
#  metrics(truth = Ex_rec, estimate = predictions)
# 
# ?metrics()
```




https://www.appsilon.com/post/r-logistic-regression
ROC. vs AUC
```{r}
library('pROC')
Reg_df <- thesis_NHRVS |>
  dplyr::select(
    Ex_rec,
             #Covariates
             Age , College , White_Race  ,
             Income_60k_plus , Combat_Veteran ,
             TOTAL_TRAUMAS , BMI ,
             #Physical Health Conditions
             Athsma , Chron_pain , Diabetes, Hrt_atk ,
             Hrt_dis , High_chol , High_bld_press , Osteoporosis , Stroke ,
             #Mental Health conditions
             AUD_Current , DUD_Current , MDD_Current , PTSD_Current , GAD_Current,
             # Data
             weight)
Reg_df <-na.omit(Reg_df)

fit1<-glm(Ex_rec~
             #Covariates
             Age + College + White_Race  +
             Income_60k_plus + Combat_Veteran +
             TOTAL_TRAUMAS + BMI +
             #Physical Health Conditions
             Athsma + Chron_pain + Diabetes+ Hrt_atk +
             Hrt_dis + High_chol + High_bld_press + Osteoporosis + Stroke +
             #Mental Health conditions
             AUD_Current + DUD_Current + MDD_Current + PTSD_Current + GAD_Current,
             # Data
             data =Reg_df,
             # Specify type of regression
             family="binomial",weights = weight)


# just number of conditions
probabilities <-  predict(fit1, NewData=Reg_df ,type = "response")
predicted.classes <- ifelse(probabilities > 0.5, 1,0)

#confusion matrix
# table(HC_df$Ex_rec, predicted.classes)
#roc
roc1 <- roc(response = Reg_df$Ex_rec,
               predictor = probabilities)

ggroc(roc1, legacy.axes = TRUE) +
  labs(x = 'False-positive rate', y = 'True-positive rate',
       title = 'ROC curve\nEx_rec ~ # Health Conditions + Covariates') +
  annotate('text', x = .5, y = .5, label = paste0('AUC: ', round(auc(roc1), digits = 2)))
```



predictive probabilities
```{r}
hist(thesis_NHRVS$MET_min_W)

HC_df <- thesis_NHRVS |>
  dplyr::select(
    #outcome
    Ex_rec,
    #covaraiates
    Age,College,White_Race,Income_60k_plus,Combat_Veteran,TOTAL_TRAUMAS,BMI,
    #HC
    edu,
    #weights
    weight)
  # ) |>
  # mutate(
  #   Ex_rec = as.factor(ifelse(Ex_rec == "Insufficient", 0,1))
  # )
HC_df <- na.omit(HC_df)
library(caret)

fit2 <- glm(relevel(Ex_rec,ref = "Sufficient")~
             #Covariates
             Age + College + White_Race  +
             Income_60k_plus + Combat_Veteran +
             TOTAL_TRAUMAS + BMI +
             #number of health conditions
             edu,
             # Data
             data =HC_df,
             # Specify weights
             family = "binomial") #weights = weight)


HC_df2<- cbind(HC_df, predict(fit2, newdata = HC_df, type = "response",
    se = TRUE))

HC_df2 <- HC_df2 |>
  mutate(
    LL = fit - (1.96 * se.fit),
    UL = fit + (1.96 * se.fit)
  )

# just number of conditions
ggplot(HC_df2, aes(x = edu, y = fit)) +
  geom_smooth(size = 1) +
  labs(x = 'Education Category', y = 'Predictive probability of insuficient activity',
       title = 'Predictive Probabilities\nExercise guidelines ~ # Education Level +  Covariates') +
  geom_vline(xintercept = 8 ,linetype="dashed",alpha = .50) + 
    geom_vline(xintercept = 12 ,linetype="dashed",alpha = .50) +
      geom_vline(xintercept = 10 ,linetype="dashed",alpha = .50) +
  annotate('text', x = 7, y = 1, label = "< HC") +
  annotate('text', x = 9, y = 1, label = "HC") +
  annotate('text', x = 11,y= 1, label = "Some\nCollege") +
  annotate('text', x = 13,y = 1, label = "College\nDegree") +
  theme_classic()

```

